<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í’ˆì§ˆ í˜„í™© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4f6f9;
  --white: #ffffff;
  --surface: #f8fafc;
  --border: #e4e9f0;
  --border-dark: #cdd5e0;
  --sidebar-bg: #0f1923;
  --sidebar-text: #8fa3b8;
  --sidebar-active: #ffffff;
  --accent: #1a56db;
  --accent-light: #eef2ff;
  --accent-hover: #1648c0;
  --danger: #e02424;
  --danger-light: #fdf2f2;
  --warning: #d97706;
  --warning-light: #fffbeb;
  --success: #057a55;
  --success-light: #f3faf7;
  --text: #111928;
  --text-muted: #6b7c93;
  --text-light: #9aa5b4;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow: 0 1px 4px rgba(0,0,0,0.07), 0 2px 8px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.10);
  --radius: 10px;
  --radius-lg: 14px;
  --sidebar-w: 230px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  overflow: hidden;
}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  background: var(--sidebar-bg);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  height: 100vh;
}

.sidebar-logo {
  padding: 24px 20px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.logo-tag {
  font-size: 10px;
  color: var(--accent);
  font-family: 'DM Mono', monospace;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 5px;
}

.logo-title {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  line-height: 1.3;
}

.sidebar-section-label {
  font-size: 10px;
  color: rgba(143,163,184,0.5);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 18px 20px 6px;
  font-family: 'DM Mono', monospace;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  color: var(--sidebar-text);
  font-size: 13.5px;
  font-weight: 500;
  transition: all 0.15s;
  border-left: 3px solid transparent;
  position: relative;
}

.nav-item:hover { color: #fff; background: rgba(255,255,255,0.04); }

.nav-item.active {
  color: #fff;
  background: rgba(26,86,219,0.18);
  border-left-color: var(--accent);
}

.nav-icon { font-size: 15px; width: 18px; text-align: center; }

.nav-badge {
  margin-left: auto;
  background: var(--danger);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 99px;
  font-family: 'DM Mono', monospace;
}

.sidebar-bottom {
  margin-top: auto;
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.06);
  font-size: 12px;
  color: rgba(143,163,184,0.5);
  font-family: 'DM Mono', monospace;
}

/* â”€â”€â”€ MAIN â”€â”€â”€ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 58px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.topbar-left h2 {
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
}

.topbar-left .breadcrumb {
  font-size: 11.5px;
  color: var(--text-light);
  margin-top: 1px;
  font-family: 'DM Mono', monospace;
}

.topbar-right { display: flex; align-items: center; gap: 10px; }

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  font-family: 'Noto Sans KR', sans-serif;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  white-space: nowrap;
}

.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-ghost {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border-dark);
}
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { opacity: 0.88; }
.btn-success { background: var(--success); color: #fff; }

/* â”€â”€â”€ CONTENT â”€â”€â”€ */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
}

/* â”€â”€â”€ PAGES â”€â”€â”€ */
.page { display: none; }
.page.active { display: block; }

/* â”€â”€â”€ KPI GRID â”€â”€â”€ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 20px;
}

.kpi-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.2s;
}
.kpi-card:hover { box-shadow: var(--shadow); }

.kpi-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}
.kpi-card.blue::after { background: var(--accent); }
.kpi-card.green::after { background: #057a55; }
.kpi-card.orange::after { background: var(--warning); }
.kpi-card.red::after { background: var(--danger); }

.kpi-icon { font-size: 25px; margin-bottom: 10px; }
.kpi-label { font-size: 13px; color: var(--text-muted); font-weight: 500; margin-bottom: 4px; }
.kpi-value {
  font-family: 'DM Mono', monospace;
  font-size: 30px;
  font-weight: 500;
  line-height: 1;
}
.kpi-card.blue .kpi-value { color: var(--accent); }
.kpi-card.green .kpi-value { color: #057a55; }
.kpi-card.orange .kpi-value { color: var(--warning); }
.kpi-card.red .kpi-value { color: var(--danger); }
.kpi-sub { font-size: 15px; color: var(--text-light); margin-top: 6px; }

/* â”€â”€â”€ GRID LAYOUTS â”€â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
.grid-3 { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; margin-bottom: 20px; }

/* â”€â”€â”€ CARD â”€â”€â”€ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  box-shadow: var(--shadow-sm);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.card-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.card-sub {
  font-size: 13px;
  color: var(--text-light);
  font-family: 'DM Mono', monospace;
  margin-top: 1px;
}

/* â”€â”€â”€ BAR CHART â”€â”€â”€ */
.bar-list { display: flex; flex-direction: column; gap: 11px; }
.bar-row { display: flex; align-items: center; gap: 10px; }
.bar-lbl { font-size: 14px; color: var(--text-muted); width: 68px; flex-shrink: 0; }
.bar-track { flex: 1; background: var(--bg); border-radius: 99px; height: 8px; }
.bar-fill { height: 100%; border-radius: 99px; transition: width 0.8s ease; }
.bar-num { font-size: 13px; font-family: 'DM Mono', monospace; color: var(--text-muted); width: 34px; text-align: right; }

/* â”€â”€â”€ BADGES â”€â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 2px 9px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
}
.badge.critical { background: var(--danger-light); color: var(--danger); }
.badge.major { background: var(--warning-light); color: var(--warning); }
.badge.minor { background: var(--success-light); color: var(--success); }
.badge.open { background: var(--accent-light); color: var(--accent); }
.badge.closed { background: #f1f5f9; color: var(--text-muted); }

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th {
  text-align: left;
  padding: 9px 14px;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
  background: var(--surface);
}
tbody td { padding: 11px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tbody tr:last-child td { border-bottom: none; }
tbody tr { transition: background 0.1s; cursor: pointer; }
tbody tr:hover td { background: #f8faff; }

/* â”€â”€â”€ FILTER ROW â”€â”€â”€ */
.filter-row {
  display: flex;
  gap: 8px;
  margin-bottom: 14px;
  align-items: center;
  flex-wrap: wrap;
}

.search-wrap { position: relative; }
.search-input {
  background: var(--white);
  border: 1px solid var(--border-dark);
  border-radius: 8px;
  padding: 8px 12px 8px 34px;
  font-size: 13px;
  font-family: 'Noto Sans KR', sans-serif;
  color: var(--text);
  outline: none;
  width: 220px;
  transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--accent); }
.search-icon-pos { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 14px; color: var(--text-light); }

.filter-select {
  background: var(--white);
  border: 1px solid var(--border-dark);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 13px;
  font-family: 'Noto Sans KR', sans-serif;
  color: var(--text);
  outline: none;
  cursor: pointer;
}
.filter-select:focus { border-color: var(--accent); }

.filter-chip {
  padding: 6px 13px;
  border-radius: 99px;
  font-size: 12px;
  font-weight: 600;
  border: 1.5px solid var(--border);
  background: var(--white);
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

/* â”€â”€â”€ CHECKLIST â”€â”€â”€ */
.check-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid var(--border);
  margin-bottom: 7px;
  background: var(--white);
  transition: border-color 0.15s;
}
.check-item:hover { border-color: var(--border-dark); }
.check-item.checked { background: var(--success-light); border-color: #a7f3d0; }
.checkbox {
  width: 20px; height: 20px;
  border: 2px solid var(--border-dark);
  border-radius: 6px;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px;
  transition: all 0.2s;
  color: transparent;
}
.check-item.checked .checkbox { background: var(--success); border-color: var(--success); color: #fff; }
.check-item.checked .check-label { color: var(--text-muted); }
.check-label { flex: 1; font-size: 13.5px; font-weight: 500; }
.check-std { font-size: 11.5px; color: var(--text-light); font-family: 'DM Mono', monospace; }

/* â”€â”€â”€ SEGMENT TABS â”€â”€â”€ */
.seg-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 3px;
  width: fit-content;
  margin-bottom: 18px;
}
.seg-tab {
  padding: 7px 18px;
  border-radius: 7px;
  font-size: 13px;
  font-weight: 600;
  border: none;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
}
.seg-tab.active { background: var(--white); color: var(--accent); box-shadow: var(--shadow-sm); }

/* â”€â”€â”€ PROGRESS BAR â”€â”€â”€ */
.progress-bar-wrap { margin-bottom: 16px; }
.progress-track { background: var(--border); border-radius: 99px; height: 6px; }
.progress-fill { height: 100%; border-radius: 99px; background: var(--success); transition: width 0.5s ease; }
.progress-info { display: flex; justify-content: space-between; margin-top: 5px; }
.progress-label { font-size: 12px; color: var(--text-muted); }
.progress-val { font-size: 12px; font-family: 'DM Mono', monospace; color: var(--success); font-weight: 600; }

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(3px);
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--white);
  border-radius: var(--radius-lg);
  width: 560px;
  max-height: 88vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.18);
  animation: modalIn 0.22s ease;
}
@keyframes modalIn { from { opacity:0; transform:translateY(12px) scale(0.98); } to { opacity:1; transform:none; } }

.modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  background: var(--white);
  z-index: 2;
}
.modal-title { font-size: 16px; font-weight: 700; }
.modal-close {
  width: 28px; height: 28px;
  border: none;
  background: var(--bg);
  border-radius: 7px;
  cursor: pointer;
  font-size: 15px;
  color: var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
}
.modal-close:hover { background: var(--border); }

.modal-body { padding: 20px 24px; }
.modal-footer {
  padding: 14px 24px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  position: sticky;
  bottom: 0;
  background: var(--white);
  z-index: 2;
}

/* â”€â”€â”€ FORM â”€â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-label { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; display: block; }
.form-required { color: var(--danger); margin-left: 2px; }
.form-input, .form-select, .form-textarea {
  width: 100%;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 9px 12px;
  color: var(--text);
  font-family: 'Noto Sans KR', sans-serif;
  font-size: 13.5px;
  outline: none;
  transition: border-color 0.2s, background 0.2s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color: var(--accent);
  background: var(--white);
}
.form-textarea { resize: vertical; min-height: 80px; line-height: 1.6; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* â”€â”€â”€ PHOTO UPLOAD â”€â”€â”€ */
.photo-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
.photo-add-btn {
  width: 80px; height: 80px;
  border: 2px dashed var(--border-dark);
  border-radius: 10px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer;
  background: var(--surface);
  color: var(--text-muted);
  font-size: 12px;
  gap: 4px;
  transition: border-color 0.2s;
}
.photo-add-btn:hover { border-color: var(--accent); color: var(--accent); }
.photo-thumb-wrap { position: relative; width: 80px; height: 80px; }
.photo-thumb-wrap img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; display: block; }
.photo-remove {
  position: absolute; top: -6px; right: -6px;
  width: 18px; height: 18px;
  background: var(--danger); color: #fff;
  border-radius: 50%; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; border: 2px solid var(--white); font-weight: 700;
}

/* â”€â”€â”€ DETAIL PANEL â”€â”€â”€ */
.detail-row { display: flex; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 12px; }
.detail-row:last-child { border-bottom: none; }
.detail-key { font-size: 12px; color: var(--text-muted); width: 110px; flex-shrink: 0; padding-top: 1px; }
.detail-val { font-size: 13px; font-weight: 600; flex: 1; }

/* â”€â”€â”€ REPORT TABLE â”€â”€â”€ */
.report-table td { font-size: 13px; }
.report-table .ok { color: var(--success); font-weight: 700; font-family: 'DM Mono', monospace; }
.report-table .ng { color: var(--danger); font-weight: 700; font-family: 'DM Mono', monospace; }

/* â”€â”€â”€ TREND SVG â”€â”€â”€ */
.trend-card { padding: 20px 20px 12px; }

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); }
.empty-state .empty-icon { font-size: 36px; margin-bottom: 10px; }
.empty-state p { font-size: 14px; }

/* â”€â”€â”€ SUMMARY BOX â”€â”€â”€ */
.summary-box {
  background: #f0f7ff;
  border: 1px solid #c3d9ff;
  border-radius: var(--radius);
  padding: 14px 16px;
  font-size: 13px;
  line-height: 1.8;
  color: var(--text-muted);
  margin-top: 16px;
}

.toast-wrap {
  position: fixed;
  bottom: 28px;
  right: 28px;
  z-index: 200;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}
.toast {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  min-width: 300px;
  max-width: 380px;
  animation: toastIn 0.3s ease;
  pointer-events: auto;
}
@keyframes toastIn {
  from { opacity:0; transform:translateY(12px) scale(0.97); }
  to   { opacity:1; transform:none; }
}
.toast.fade-out { animation: toastOut 0.3s ease forwards; }
@keyframes toastOut {
  to { opacity:0; transform:translateY(8px) scale(0.97); }
}
.toast-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
.toast-body { flex: 1; }
.toast-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
.toast-msg   { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
.toast.success { border-left: 3px solid var(--success); }
.toast.error   { border-left: 3px solid var(--danger); }
.toast.info    { border-left: 3px solid var(--accent); }

/* â”€â”€â”€ ìë™ë™ê¸°í™” í‘œì‹œ â”€â”€â”€ */
.poll-dot {
  display: inline-block;
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--success);
  margin-right: 4px;
  animation: pollPulse 2s ease infinite;
}
@keyframes pollPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }
.sync-chip {
  position: fixed;
  bottom: 28px; left: 50%;
  transform: translateX(-50%);
  background: var(--sidebar-bg);
  color: #fff;
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  padding: 5px 16px;
  border-radius: 99px;
  z-index: 150;
  display: none;
  align-items: center;
  gap: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  pointer-events: none;
}
.sync-chip.visible { display: flex; }

/* â”€â”€â”€ UPLOAD OVERLAY â”€â”€â”€ */
.upload-overlay {
  position: fixed; inset: 0;
  background: rgba(26,86,219,0.08);
  border: 3px dashed var(--accent);
  z-index: 300;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 12px;
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
  pointer-events: none;
}
.upload-overlay.active { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë°”ì¼ ë°˜ì‘í˜•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* í–„ë²„ê±° ë²„íŠ¼ */
.hamburger {
  display: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  flex-direction: column;
  gap: 5px;
}
.hamburger span {
  display: block;
  width: 22px;
  height: 2px;
  background: var(--text);
  border-radius: 2px;
  transition: all 0.25s;
}

/* ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 199;
}
.sidebar-overlay.active { display: block; }

/* í•˜ë‹¨ íƒ­ë°” */
.mobile-tabbar {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 60px;
  background: var(--white);
  border-top: 1px solid var(--border);
  z-index: 150;
  justify-content: space-around;
  align-items: center;
}
.mobile-tab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  padding: 6px 0;
  color: var(--text-muted);
  font-size: 10px;
  font-weight: 600;
  transition: color 0.15s;
  position: relative;
}
.mobile-tab.active { color: var(--accent); }
.mobile-tab-icon { font-size: 20px; line-height: 1; }
.mobile-tab-badge {
  position: absolute;
  top: 4px;
  right: calc(50% - 18px);
  background: var(--danger);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 99px;
  font-family: 'DM Mono', monospace;
}

/* ëª¨ë°”ì¼ ë“±ë¡ FAB ë²„íŠ¼ */
.fab-btn {
  display: none;
  position: fixed;
  bottom: 72px;
  right: 18px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  font-size: 26px;
  line-height: 1;
  border: none;
  cursor: pointer;
  z-index: 149;
  box-shadow: 0 4px 16px rgba(26,86,219,0.35);
  align-items: center;
  justify-content: center;
}

@media (max-width: 768px) {
  /* ë ˆì´ì•„ì›ƒ */
  body { overflow: auto; flex-direction: column; }

  /* ì‚¬ì´ë“œë°”: ìŠ¬ë¼ì´ë“œ ì˜¤ë²„ë ˆì´ */
  .sidebar {
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    z-index: 200;
    transform: translateX(-100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
  }
  .sidebar.open { transform: translateX(0); }

  /* ë©”ì¸ */
  .main { width: 100%; min-height: 100vh; }

  /* íƒ‘ë°” */
  .topbar {
    padding: 0 14px;
    height: 52px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .topbar-left h2 { font-size: 15px; }
  .topbar-right .btn-ghost { display: none; } /* ë‚´ë³´ë‚´ê¸° ìˆ¨ê¹€ */
  .topbar-right .btn-primary { display: none; } /* ìƒë‹¨ ë“±ë¡ ë²„íŠ¼ ìˆ¨ê¹€ (FABë¡œ ëŒ€ì²´) */

  /* í–„ë²„ê±° í‘œì‹œ */
  .hamburger { display: flex; }

  /* ì½˜í…ì¸  ì—¬ë°± (í•˜ë‹¨ íƒ­ë°” ê³µê°„) */
  .content { padding: 16px 14px 80px; }

  /* KPI ê·¸ë¦¬ë“œ: 2ì—´ */
  .kpi-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
  .kpi-card { padding: 14px; }
  .kpi-value { font-size: 24px !important; }
  .kpi-label { font-size: 11px !important; }
  .kpi-sub   { font-size: 11px !important; }

  /* ì°¨íŠ¸ ê·¸ë¦¬ë“œ: 1ì—´ */
  .grid-2 { grid-template-columns: 1fr; gap: 10px; }
  .grid-3 { grid-template-columns: 1fr; gap: 10px; }

  /* í…Œì´ë¸” ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { min-width: 700px; }

  /* í•„í„° í–‰ */
  .filter-row { flex-wrap: wrap; gap: 8px; }
  .search-wrap { width: 100%; }
  .search-input { width: 100%; }

  /* ëª¨ë‹¬ ì „ì²´í™”ë©´ */
  .modal {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    border-radius: 16px 16px 0 0 !important;
    position: fixed !important;
    bottom: 60px !important;
    left: 0 !important;
    right: 0 !important;
    max-height: calc(90vh - 60px) !important;
    overflow-y: hidden !important;
    display: flex !important;
    flex-direction: column !important;
  }
  .modal-body {
    overflow-y: auto !important;
    flex: 1 !important;
    -webkit-overflow-scrolling: touch !important;
  }
  .modal-footer {
    flex-shrink: 0 !important;
    position: static !important;
    padding-bottom: 20px !important;
  }
  .modal-overlay { align-items: flex-end !important; }

  /* í•˜ë‹¨ íƒ­ë°”Â·FAB í‘œì‹œ */
  .mobile-tabbar { display: flex; }
  .fab-btn { display: flex; }

  /* ë°œìƒì²˜ ê°œë³„ ì°¨íŠ¸ 1ì—´ */
  #occ-charts-wrap { grid-template-columns: 1fr !important; }

  /* sync-chip ìœ„ì¹˜ ì¡°ì • */
  .sync-chip { bottom: 70px; }
}
</style>
</head>
<body>

<!-- SYNC CHIP -->
<div class="sync-chip" id="sync-chip">
  <span class="poll-dot"></span>
  ìë™ ë™ê¸°í™” ì¤‘ Â· <span id="poll-countdown">60</span>ì´ˆ í›„ ê°±ì‹ 
</div>

<!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- í•˜ë‹¨ íƒ­ë°” (ëª¨ë°”ì¼) -->
<div class="mobile-tabbar">
  <div class="mobile-tab active" id="mob-tab-home" onclick="goPage('home',null);setMobTab('home')">
    <span class="mobile-tab-icon">ğŸ“Š</span>
    <span>ëŒ€ì‹œë³´ë“œ</span>
  </div>
  <div class="mobile-tab" id="mob-tab-defects" onclick="goPage('defects',null);setMobTab('defects')">
    <span class="mobile-tab-icon">ğŸ”´</span>
    <span>ë¶ˆëŸ‰ ê´€ë¦¬</span>
    <span class="mobile-tab-badge" id="mob-open-badge"></span>
  </div>
  <div class="mobile-tab" id="mob-tab-report" onclick="goPage('report',null);setMobTab('report')">
    <span class="mobile-tab-icon">ğŸ“„</span>
    <span>ë³´ê³ ì„œ</span>
  </div>
</div>

<!-- FAB ë“±ë¡ ë²„íŠ¼ (ëª¨ë°”ì¼) -->
<button class="fab-btn" onclick="openModal()" aria-label="ë¶ˆëŸ‰ ë“±ë¡">ï¼‹</button>

<!-- â”€â”€â”€ SIDEBAR â”€â”€â”€ -->
<div class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-tag">QMS v1.0</div>
    <div class="logo-title">í’ˆì§ˆ í˜„í™©<br>ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
  </div>
  <div class="sidebar-section-label">ë©”ë‰´</div>
  <div class="nav-item active" onclick="goPage('home',this)">
    <span class="nav-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
  </div>
  <div class="nav-item" onclick="goPage('defects',this)">
    <span class="nav-icon">ğŸ”´</span> ë¶ˆëŸ‰ ê´€ë¦¬
    <span class="nav-badge" id="open-badge">7</span>
  </div>
  <div class="nav-item" onclick="goPage('report',this)">
    <span class="nav-icon">ğŸ“„</span> ì›”ê°„ ë³´ê³ ì„œ
  </div>
  <div style="padding: 10px 12px 6px;">
    <button id="sheet-btn" onclick="openGasSetup()" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:9px 12px;color:var(--sidebar-text);font-size:12px;font-family:'Noto Sans KR',sans-serif;font-weight:600;cursor:pointer;text-align:left;transition:background 0.15s;">
      ğŸ”— Sheets ì—°ë™ ì„¤ì •
    </button>
  </div>
  <div style="padding: 4px 12px 6px; display:flex; gap:6px;">
    <button onclick="sheetLoad()" title="Sheetsì—ì„œ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"
      style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 8px;color:var(--sidebar-text);font-size:12px;font-family:'Noto Sans KR',sans-serif;font-weight:600;cursor:pointer;transition:all 0.15s;">
      ğŸ”„ ìƒˆë¡œê³ ì¹¨
    </button>
    <button id="poll-btn" onclick="togglePolling()" title="60ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ Sheets í™•ì¸"
      style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 8px;color:var(--sidebar-text);font-size:12px;font-family:'Noto Sans KR',sans-serif;font-weight:600;cursor:pointer;transition:all 0.15s;">
      â± ìë™ë™ê¸°í™”
    </button>
  </div>
  </div>
  <div class="sidebar-bottom">
    2025-02-24 &nbsp;|&nbsp; v1.0.0
  </div>
</div>

<!-- â”€â”€â”€ MAIN â”€â”€â”€ -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="ë©”ë‰´">
        <span></span><span></span><span></span>
      </button>
      <div class="topbar-left">
        <h2 id="page-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>
        <div class="breadcrumb" id="page-sub">í’ˆì§ˆ í˜„í™© Â· 2025ë…„ 2ì›”</div>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-ghost btn-sm">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-primary btn-sm" onclick="openModal()">ï¼‹ ë¶ˆëŸ‰ ë“±ë¡</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- â•â•â•â• ëŒ€ì‹œë³´ë“œ â•â•â•â• -->
    <div id="page-home" class="page active">

      <!-- ìƒì‚°ìˆ˜ëŸ‰ ì…ë ¥ -->
      <div id="prod-qty-wrap" style="background:var(--white);border:1px solid var(--border);border-radius:12px;padding:12px 18px;margin-bottom:14px;box-shadow:var(--shadow-sm);"></div>

      <!-- KPI ì¹´ë“œ -->
      <div class="kpi-grid">
        <div class="kpi-card blue">
          <div class="kpi-icon">ğŸ”¬</div>
          <div class="kpi-label">ë‹¹ì›” ë¶ˆëŸ‰ ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-total">-</div>
          <div class="kpi-sub" id="kpi-total-sub">ë‹¹ì›” ë“±ë¡ ê¸°ì¤€</div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-icon">ğŸ­</div>
          <div class="kpi-label">ê³ ê°ì‚¬ ë¶ˆëŸ‰ ê±´ìˆ˜</div>
          <div class="kpi-value" id="kpi-closed-rate">-</div>
          <div class="kpi-sub" id="kpi-closed-sub">HMI 1 + HMI 2</div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon">ğŸ“Š</div>
          <div class="kpi-label">ê³ ê°ì‚¬ ë¶ˆëŸ‰ PPM</div>
          <div class="kpi-value" id="kpi-thismonth">-</div>
          <div class="kpi-sub" id="kpi-thismonth-sub">ìƒì‚°ìˆ˜ëŸ‰ ê¸°ì¤€</div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-icon">âš™ï¸</div>
          <div class="kpi-label">ì‚¬ë‚´ ë¶ˆëŸ‰ PPM</div>
          <div class="kpi-value" id="kpi-open">-</div>
          <div class="kpi-sub" id="kpi-open-sub">ìˆ˜ì…ê²€ì‚¬~PDI ê¸°ì¤€</div>
        </div>
      </div>

      <div class="grid-2">
        <!-- ë¶ˆëŸ‰ ìœ í˜•ë³„ -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ë¶ˆëŸ‰ ìœ í˜•ë³„ í˜„í™©</div>
              <div class="card-sub">ì „ì²´ ëˆ„ê³„</div>
            </div>
          </div>
          <div class="bar-list" id="chart-type"></div>
        </div>

        <!-- ëª¨ë¸ë³„ í˜„í™© -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ëª¨ë¸ë³„ í˜„í™©</div>
              <div class="card-sub">ì „ì²´ ëˆ„ê³„</div>
            </div>
          </div>
          <div class="bar-list" id="chart-model"></div>
        </div>

        <!-- ë°œìƒì²˜ë³„ í˜„í™© -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ë°œìƒì²˜ë³„ í˜„í™©</div>
              <div class="card-sub">ì „ì²´ ëˆ„ê³„</div>
            </div>
          </div>
          <div class="bar-list" id="chart-occurrence"></div>
        </div>

        <!-- ê·€ì±…ì²˜ë³„ í˜„í™© -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ê·€ì±…ì²˜ë³„ í˜„í™©</div>
              <div class="card-sub">ì „ì²´ ëˆ„ê³„</div>
            </div>
          </div>
          <div class="bar-list" id="chart-owner"></div>
        </div>

        <!-- í’ˆëª©ëª…ë³„ í˜„í™© -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">í’ˆëª©ëª…ë³„ í˜„í™©</div>
              <div class="card-sub">ì „ì²´ ëˆ„ê³„</div>
            </div>
          </div>
          <div class="bar-list" id="chart-item"></div>
        </div>

      </div><!-- /grid-2 -->

      <!-- ì›”ë³„ ì¶”ì´ -->
      <div class="card" style="margin-bottom:14px;">
        <div class="card-header">
          <div>
            <div class="card-title">ì£¼ë³„ ë¶ˆëŸ‰ ì¶”ì´</div>
            <div class="card-sub" id="trend-sub">ë‹¹ì›” ì£¼ë³„ í˜„í™©</div>
          </div>
        </div>
        <svg id="trend-svg" width="100%" height="130" viewBox="-15 0 950 130" preserveAspectRatio="none"></svg>
      </div>

      <!-- ë°œìƒì²˜ë³„ ì¶”ì´ -->
      <div class="card" style="margin-bottom:14px;">
        <div class="card-header">
          <div>
            <div class="card-title">ë°œìƒì²˜ë³„ ì£¼ë³„ ì¶”ì´</div>
            <div class="card-sub">ë‹¹ì›” ì£¼ë³„ Â· ë°œìƒì²˜ë³„ ê°œë³„ í˜„í™©</div>
          </div>
        </div>
        <div id="occ-charts-wrap" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;"></div>
      </div>

    </div><!-- /page-home -->

    <!-- â•â•â•â• ë¶ˆëŸ‰ ê´€ë¦¬ â•â•â•â• -->
    <div id="page-defects" class="page">
      <div class="filter-row">
        <div class="search-wrap">
          <span class="search-icon-pos">ğŸ”</span>
          <input class="search-input" placeholder="í’ˆëª©ëª…, ìœ í˜•, ê·€ì±…ì²˜ ê²€ìƒ‰..." oninput="filterDefects(this.value)" id="search-inp">
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <input type="file" id="excel-upload-input" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleExcelUpload(this)">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('excel-upload-input').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
          <button class="btn btn-ghost btn-sm" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-primary btn-sm" onclick="openModal()">ï¼‹ ë¶ˆëŸ‰ ë“±ë¡</button>
        </div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ì°¨ì¢…</th>
                <th>í’ˆë²ˆ</th>
                <th>í’ˆëª©ëª…</th>
                <th>ë¶ˆëŸ‰ ìœ í˜•</th>
                <th>ë°œìƒì²˜</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê·€ì±…ì²˜</th>
                <th>ë“±ë¡ì¼</th>
                <th>ë¶ˆëŸ‰ ë‚´ìš©</th>
                <th>í¸ì§‘</th>
              </tr>
            </thead>
            <tbody id="defect-tbody"></tbody>
          </table>
        </div>
      </div>
    </div><!-- /page-defects -->

    <!-- â•â•â•â• ì›”ê°„ ë³´ê³ ì„œ â•â•â•â• -->
    <div id="page-report" class="page">

      <!-- ì›” ì„ íƒ -->
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
        <button class="btn btn-ghost btn-sm" onclick="changeReportMonth(-1)">â—€</button>
        <span id="report-month-label" style="font-size:15px;font-weight:700;color:var(--text);min-width:100px;text-align:center;"></span>
        <button class="btn btn-ghost btn-sm" onclick="changeReportMonth(1)">â–¶</button>
      </div>

      <!-- KPI ì¹´ë“œ -->
      <div class="kpi-grid">
        <div class="kpi-card blue">
          <div class="kpi-icon">ğŸ“‹</div>
          <div class="kpi-label">ë‹¹ì›” ë¶ˆëŸ‰ ê±´ìˆ˜</div>
          <div class="kpi-value" id="r-total">-</div>
          <div class="kpi-sub" id="r-total-sub"></div>
        </div>
        <div class="kpi-card green">
          <div class="kpi-icon">âœ…</div>
          <div class="kpi-label">ì™„ë£Œ ì²˜ë¦¬ìœ¨</div>
          <div class="kpi-value" id="r-closed-rate">-</div>
          <div class="kpi-sub" id="r-closed-sub"></div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon">âš ï¸</div>
          <div class="kpi-label">ë¯¸ì²˜ë¦¬ ê±´ìˆ˜</div>
          <div class="kpi-value" id="r-open">-</div>
          <div class="kpi-sub" id="r-open-sub"></div>
        </div>
        <div class="kpi-card red">
          <div class="kpi-icon">ğŸ“ˆ</div>
          <div class="kpi-label">ì „ì›” ëŒ€ë¹„</div>
          <div class="kpi-value" id="r-diff">-</div>
          <div class="kpi-sub" id="r-diff-sub"></div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ ê·¸ë¦¬ë“œ -->
      <div class="grid-2">
        <div class="card">
          <div class="card-header"><div>
            <div class="card-title">ë¶ˆëŸ‰ ìœ í˜•ë³„ í˜„í™©</div>
            <div class="card-sub" id="r-type-sub"></div>
          </div></div>
          <div id="r-chart-type"></div>
        </div>
        <div class="card">
          <div class="card-header"><div>
            <div class="card-title">ë°œìƒì²˜ë³„ í˜„í™©</div>
            <div class="card-sub" id="r-occ-sub"></div>
          </div></div>
          <div class="bar-list" id="r-chart-occ"></div>
        </div>
        <div class="card">
          <div class="card-header"><div>
            <div class="card-title">ëª¨ë¸ë³„ í˜„í™©</div>
            <div class="card-sub" id="r-model-sub"></div>
          </div></div>
          <div class="bar-list" id="r-chart-model"></div>
        </div>
        <div class="card">
          <div class="card-header"><div>
            <div class="card-title">ê·€ì±…ì²˜ë³„ í˜„í™©</div>
            <div class="card-sub" id="r-owner-sub"></div>
          </div></div>
          <div class="bar-list" id="r-chart-owner"></div>
        </div>
      </div>

      <!-- ì›”ë³„ ì¶”ì´ (í•´ë‹¹ ì—°ë„ 12ê°œì›”) -->
      <div class="card" style="margin-bottom:14px;">
        <div class="card-header"><div>
          <div class="card-title">ì›”ë³„ ë¶ˆëŸ‰ ì¶”ì´</div>
          <div class="card-sub" id="r-trend-sub"></div>
        </div></div>
        <svg id="r-trend-svg" width="100%" height="130" viewBox="-15 0 950 130" preserveAspectRatio="none"></svg>
      </div>

      <!-- ë°œìƒì²˜ë³„ ê°œë³„ ì¶”ì´ -->
      <div class="card" style="margin-bottom:14px;">
        <div class="card-header"><div>
          <div class="card-title">ë°œìƒì²˜ë³„ ì›”ë³„ ì¶”ì´</div>
          <div class="card-sub" id="r-occ-trend-sub"></div>
        </div></div>
        <div id="r-occ-charts-wrap" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;"></div>
      </div>

      <!-- ë‹¹ì›” ë¶ˆëŸ‰ ëª©ë¡ -->
      <div class="card" style="margin-top:4px;">
        <div class="card-header"><div>
          <div class="card-title">ë‹¹ì›” ë¶ˆëŸ‰ ëª©ë¡</div>
          <div class="card-sub" id="r-list-sub"></div>
        </div></div>
        <div class="table-wrap">
          <table class="report-table">
            <thead>
              <tr><th>ì°¨ì¢…</th><th>í’ˆë²ˆ</th><th>í’ˆëª©ëª…</th><th>ë¶ˆëŸ‰ìœ í˜•</th><th>ë°œìƒì²˜</th><th>ìˆ˜ëŸ‰</th><th>ê·€ì±…ì²˜</th><th>ë“±ë¡ì¼</th><th>ìƒíƒœ</th></tr>
            </thead>
            <tbody id="r-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ì¢…í•© ì˜ê²¬ -->
      <div class="card" style="margin-top:4px;">
        <div class="summary-box" id="r-summary"></div>
      </div>

    </div><!-- /page-report -->

  </div><!-- /content -->
</div><!-- /main -->

<!-- TOAST (fixed positioning, doesn't affect flex layout) -->
<div class="toast-wrap" id="toast-wrap"></div>
<!-- DRAG DROP OVERLAY -->
<div class="upload-overlay" id="upload-overlay">
  <span style="font-size:48px;">ğŸ“‚</span>
  ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”
</div>

<!-- â•â•â•â• ë¶ˆëŸ‰ ë“±ë¡ ëª¨ë‹¬ â•â•â•â• -->
<div class="modal-overlay" id="modal-reg">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ğŸ”´ ë¶ˆëŸ‰ ë“±ë¡</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì°¨ì¢…</label>
          <input class="form-input" id="f-carmodel" placeholder="ì˜ˆ: EV6, K8">
        </div>
        <div class="form-group">
          <label class="form-label">í’ˆë²ˆ</label>
          <input class="form-input" id="f-partno" placeholder="ì˜ˆ: PA-10324">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">í’ˆëª©ëª… <span class="form-required">*</span></label>
          <input class="form-input" id="f-item" placeholder="ì˜ˆ: ë³¼íŠ¸ M10 x 30">
        </div>
      </div>
      <div class="form-row-3">
        <div class="form-group">
          <label class="form-label">ë¶ˆëŸ‰ ìœ í˜•</label>
          <select class="form-select" id="f-type">
            <option>ì¹˜ìˆ˜ ë¶ˆëŸ‰</option>
            <option>ì™¸ê´€ ë¶ˆëŸ‰</option>
            <option>ìš©ì ‘ ë¶ˆëŸ‰</option>
            <option>ê¸°íƒ€</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë°œìƒì²˜</label>
          <select class="form-select" id="f-sev">
            <option value="ìˆ˜ì…ê²€ì‚¬">ìˆ˜ì…ê²€ì‚¬</option>
            <option value="í”„ë ˆìŠ¤ë¼ì¸">í”„ë ˆìŠ¤ë¼ì¸</option>
            <option value="ì¡°ë¦½ë¼ì¸">ì¡°ë¦½ë¼ì¸</option>
            <option value="PDI">PDI</option>
            <option value="HMI 1">HMI 1</option>
            <option value="HMI 2">HMI 2</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë¶ˆëŸ‰ ìˆ˜ëŸ‰</label>
          <input class="form-input" id="f-qty" type="number" min="1" placeholder="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ê·€ì±…ì²˜</label>
          <select class="form-select" id="f-owner">
            <option value="ìì¬">ìì¬</option>
            <option value="í’ˆì§ˆ">í’ˆì§ˆ</option>
            <option value="ìƒì‚°">ìƒì‚°</option>
            <option value="ë¬¼ë¥˜">ë¬¼ë¥˜</option>
            <option value="ë³´ì „">ë³´ì „</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë¶ˆëŸ‰ ë‚´ìš©</label>
        <textarea class="form-textarea" id="f-desc" placeholder="ë¶ˆëŸ‰ í˜„ìƒ, ìœ„ì¹˜, ë°œìƒ ìƒí™© ë“± ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ì‚¬ì§„ ì²¨ë¶€ <span style="color:var(--text-light);font-weight:400;">(ìµœëŒ€ 3ì¥)</span></label>
        <input type="file" id="f-photos" accept="image/*" multiple style="display:none;" onchange="handlePhotos(this)">
        <div class="photo-grid" id="photo-grid">
          <div class="photo-add-btn" onclick="document.getElementById('f-photos').click()">
            <span style="font-size:22px;">ğŸ“·</span>
            <span>ì‚¬ì§„ ì¶”ê°€</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="submitDefect()">ë“±ë¡í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• ë¶ˆëŸ‰ ìƒì„¸ ëª¨ë‹¬ â•â•â•â• -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">ë¶ˆëŸ‰ ìƒì„¸ ì •ë³´</div>
      <button class="modal-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="modal-body" id="detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeDetail()">ë‹«ê¸°</button>
      <button class="btn btn-primary" id="detail-action-btn"></button>
    </div>
  </div>
</div>

<!-- â•â•â•â• ë¶ˆëŸ‰ í¸ì§‘ ëª¨ë‹¬ â•â•â•â• -->
<div class="modal-overlay" id="modal-edit">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">âœï¸ ë¶ˆëŸ‰ í¸ì§‘</div>
        <div style="font-size:11px;color:var(--text-light);font-family:'DM Mono',monospace;margin-top:3px;" id="edit-id-label"></div>
      </div>
      <button class="modal-close" onclick="closeEditModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì°¨ì¢…</label>
          <input class="form-input" id="e-carmodel" placeholder="ì˜ˆ: EV6, K8">
        </div>
        <div class="form-group">
          <label class="form-label">í’ˆë²ˆ</label>
          <input class="form-input" id="e-partno" placeholder="ì˜ˆ: PA-10324">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">í’ˆëª©ëª… <span class="form-required">*</span></label>
          <input class="form-input" id="e-item" placeholder="ì˜ˆ: ë³¼íŠ¸ M10 x 30">
        </div>
      </div>
      <div class="form-row-3">
        <div class="form-group">
          <label class="form-label">ë¶ˆëŸ‰ ìœ í˜•</label>
          <select class="form-select" id="e-type">
            <option>ì¹˜ìˆ˜ ë¶ˆëŸ‰</option>
            <option>ì™¸ê´€ ë¶ˆëŸ‰</option>
            <option>ìš©ì ‘ ë¶ˆëŸ‰</option>
            <option>ê¸°íƒ€</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë°œìƒì²˜</label>
          <select class="form-select" id="e-sev">
            <option value="ìˆ˜ì…ê²€ì‚¬">ìˆ˜ì…ê²€ì‚¬</option>
            <option value="í”„ë ˆìŠ¤ë¼ì¸">í”„ë ˆìŠ¤ë¼ì¸</option>
            <option value="ì¡°ë¦½ë¼ì¸">ì¡°ë¦½ë¼ì¸</option>
            <option value="PDI">PDI</option>
            <option value="HMI 1">HMI 1</option>
            <option value="HMI 2">HMI 2</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë¶ˆëŸ‰ ìˆ˜ëŸ‰</label>
          <input class="form-input" id="e-qty" type="number" min="1" placeholder="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ê·€ì±…ì²˜</label>
          <select class="form-select" id="e-owner">
            <option value="ìì¬">ìì¬</option>
            <option value="í’ˆì§ˆ">í’ˆì§ˆ</option>
            <option value="ìƒì‚°">ìƒì‚°</option>
            <option value="ë¬¼ë¥˜">ë¬¼ë¥˜</option>
            <option value="ë³´ì „">ë³´ì „</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ìƒíƒœ</label>
          <select class="form-select" id="e-status">
            <option value="open">ë¯¸ì²˜ë¦¬</option>
            <option value="closed">ì™„ë£Œ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ë“±ë¡ì¼</label>
          <input class="form-input" id="e-date" type="date">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë¶ˆëŸ‰ ë‚´ìš©</label>
        <textarea class="form-textarea" id="e-desc" placeholder="ë¶ˆëŸ‰ í˜„ìƒ, ìœ„ì¹˜, ë°œìƒ ìƒí™© ë“± ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between;">
      <button class="btn btn-danger btn-sm" onclick="deleteDefect()">ğŸ—‘ ì‚­ì œ</button>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" onclick="closeEditModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Google Sheets ì—°ë™ ì„¤ì •
//  Apps Script ë°°í¬ í›„ ì‚¬ì´ë“œë°” í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ URL ì…ë ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GAS_URL = localStorage.getItem('gas_url') || 'https://script.google.com/macros/s/AKfycbzwPeSmMkhJYaH-ryOKSd8cuJr6vQERmFzKmSbpV-XeAk56m6cpk9YFjh06xlQjo-qq/exec';

// â•â• DATA â•â•
let defects = [
  { carModel:'EV6',  partNo:'PA-10324', item:'ë³¼íŠ¸ M10',     serial:'SN-00101', type:'ì¹˜ìˆ˜ ë¶ˆëŸ‰', occurrence:'ìì‚¬',   qty:'20', date:'2025-02-24', owner:'ê¹€ì² ìˆ˜', status:'open',   desc:'ì§ê²½ ê³µì°¨ 0.3mm ì´ˆê³¼, 20ea ë°œìƒ.', photos:[] },
  { carModel:'K8',   partNo:'NB-20011', item:'ë„ˆíŠ¸ M8',      serial:'-',        type:'ì™¸ê´€ ë¶ˆëŸ‰', occurrence:'í˜‘ë ¥ì‚¬', qty:'5',  date:'2025-02-23', owner:'ì´ì˜í¬', status:'open',   desc:'í‘œë©´ ìŠ¤í¬ë˜ì¹˜ 5ê°œì†Œ ë°œìƒ', photos:[] },
  { carModel:'EV6',  partNo:'PA-10088', item:'í”Œë ˆì´íŠ¸ Aí˜•', serial:'SN-00088', type:'ì¹˜ìˆ˜ ë¶ˆëŸ‰', occurrence:'ìì‚¬',   qty:'12', date:'2025-02-22', owner:'ë°•ë¯¼ì¤€', status:'closed', desc:'í™€ ìœ„ì¹˜ í¸ì°¨ 3mm, ì „ìˆ˜ ì¬ì‘ì—… ì™„ë£Œ', photos:[] },
  { carModel:'GV80', partNo:'GC-30221', item:'ì¼€ì´ìŠ¤ Bí˜•',   serial:'-',        type:'ê¸°ëŠ¥ ë¶ˆëŸ‰', occurrence:'í˜‘ë ¥ì‚¬', qty:'3',  date:'2025-02-21', owner:'ìµœìˆ˜ì§„', status:'open',   desc:'ì ê¸ˆ ì¥ì¹˜ ì‘ë™ ë¶ˆëŸ‰, ì›ì¸ ì¡°ì‚¬ ì¤‘', photos:[] },
  { carModel:'K5',   partNo:'NB-11044', item:'íŒ¨í‚¹ ì„¸íŠ¸',    serial:'-',        type:'í¬ì¥ ë¶ˆëŸ‰', occurrence:'ì‹œì¥',   qty:'50', date:'2025-02-20', owner:'ì •ë„í˜„', status:'closed', desc:'ë¼ë²¨ ë¶€ì°© ì˜¤ë¥˜, ì¬ì‘ì—… ì™„ë£Œ', photos:[] },
  { carModel:'K8',   partNo:'NB-20098', item:'ìƒ¤í”„íŠ¸ 12Î¦',  serial:'-',        type:'ì™¸ê´€ ë¶ˆëŸ‰', occurrence:'ìì‚¬',   qty:'2',  date:'2025-02-19', owner:'ê¹€ì² ìˆ˜', status:'closed', desc:'ë„ê¸ˆ ë¶ˆëŸ‰ 3ê°œì†Œ', photos:[] },
  { carModel:'EV9',  partNo:'EV-40312', item:'ë¸Œë˜í‚· Cí˜•',   serial:'SN-00095', type:'ì¹˜ìˆ˜ ë¶ˆëŸ‰', occurrence:'í˜‘ë ¥ì‚¬', qty:'8',  date:'2025-02-18', owner:'ì´ì˜í¬', status:'open',   desc:'ë†’ì´ ì¹˜ìˆ˜ 2mm ì´ˆê³¼, CAPA ì‘ì„± ì¤‘', photos:[] },
];


// â•â• GOOGLE SHEETS ì—°ë™ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function stripPhotos(d) { const {photos,_row,...rest}=d; return rest; }

async function sheetLoad() {
  if (!GAS_URL) return;
  setLoadingBar(true);
  try {
    // ë¶ˆëŸ‰ ë°ì´í„° + ìƒì‚°ìˆ˜ëŸ‰ ë³‘ë ¬ ë¡œë”©
    const [res, prodRes] = await Promise.all([
      fetch(GAS_URL + '?t=' + Date.now()),
      fetch(GAS_URL + '?action=production&t=' + Date.now())
    ]);
    const json     = await res.json();
    const prodJson = await prodRes.json();

    if (!json.ok) throw new Error(json.error);
    if (json.data.length > 0) {
      defects = json.data.map(d => ({ ...d, photos:[] }));
    }
    if (prodJson.ok && prodJson.data) {
      productionData = {};
      prodJson.data.forEach(r => { if(r.ym) productionData[r.ym] = Number(r.qty)||0; });
    }
    renderHomeDefects(); renderTable(); updateBadge(); renderDashboard();
    showToast('success','Google Sheets ì—°ë™ ì™„ë£Œ', `ë¶ˆëŸ‰ ${defects.length}ê±´ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
  } catch(e) {
    showToast('error','Sheets ì—°ê²° ì‹¤íŒ¨', e.message + '<br>URLì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.');
  } finally { setLoadingBar(false); }
}

// ìƒì‚°ìˆ˜ëŸ‰ ì €ì¥
async function saveProdQty(ym, qty) {
  if (!GAS_URL) return;
  try {
    await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'production_update', ym, qty: Number(qty) }) });
    productionData[ym] = Number(qty);
    renderDashboard();
    showToast('success', 'ìƒì‚°ìˆ˜ëŸ‰ ì €ì¥', `${ym} â†’ ${Number(qty).toLocaleString()}ê°œ`);
  } catch(e) { showToast('error','ì €ì¥ ì‹¤íŒ¨', e.message); }
}

async function sheetSync(showMsg=true) {
  if (!GAS_URL) return;
  try {
    await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'sync', data: defects.map(stripPhotos) }) });
    if (showMsg) showToast('success','Sheets ì €ì¥ ì™„ë£Œ', `${defects.length}ê±´ ë™ê¸°í™” ì™„ë£Œ`);
  } catch(e) { showToast('error','ì €ì¥ ì‹¤íŒ¨', e.message); }
}

async function sheetAdd(d) {
  if (!GAS_URL) return;
  try { await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'add', data: stripPhotos(d) }) }); } catch(e) {}
}

async function sheetUpdate(d) {
  if (!GAS_URL) return;
  try { await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'update', data: stripPhotos(d) }) }); } catch(e) {}
}

async function sheetDelete(partNo) {
  if (!GAS_URL) return;
  try { await fetch(GAS_URL, { method:'POST', body: JSON.stringify({ action:'delete', partNo }) }); } catch(e) {}
}

function setLoadingBar(on) {
  let bar = document.getElementById('loading-bar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id='loading-bar';
    bar.style.cssText='position:fixed;top:0;left:0;right:0;height:3px;background:var(--accent);z-index:9999;animation:loadPulse 1s ease infinite;';
    document.head.insertAdjacentHTML('beforeend','<style>@keyframes loadPulse{0%,100%{opacity:.4}50%{opacity:1}}</style>');
    document.body.prepend(bar);
  }
  bar.style.display = on ? 'block' : 'none';
}

function openGasSetup() {
  const url = prompt(
    'ğŸ”— Google Apps Script ë°°í¬ URL ì…ë ¥\n\n' +
    'ğŸ“‹ ì„¤ì • ë°©ë²•:\n' +
    '1. Google Sheets ì—´ê¸°\n' +
    '2. í™•ì¥ í”„ë¡œê·¸ë¨ â†’ Apps Script\n' +
    '3. apps-script.gs ì½”ë“œ ë¶™ì—¬ë„£ê¸° â†’ ì €ì¥\n' +
    '4. ë°°í¬ â†’ ìƒˆ ë°°í¬ â†’ ì›¹ ì•±\n' +
    '   ì‹¤í–‰ ê³„ì •: ë³¸ì¸ / ì•¡ì„¸ìŠ¤: ëˆ„êµ¬ë‚˜\n' +
    '5. ë°°í¬ URL ë³µì‚¬ í›„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°',
    GAS_URL
  );
  if (url === null) return;
  GAS_URL = url.trim();
  localStorage.setItem('gas_url', GAS_URL);
  if (GAS_URL) { showToast('info','URL ì €ì¥ë¨','Sheets ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘â€¦'); sheetLoad(); }
  else { showToast('info','ì—°ë™ í•´ì œ','Google Sheets ì—°ë™ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
  updateSheetBtn();
}

function updateSheetBtn() {
  const btn = document.getElementById('sheet-btn');
  if (!btn) return;
  if (GAS_URL) {
    btn.textContent = 'ğŸŸ¢ Sheets ì—°ë™ë¨';
    btn.style.color = 'var(--success)';
  } else {
    btn.textContent = 'ğŸ”— Sheets ì—°ë™ ì„¤ì •';
    btn.style.color = 'var(--sidebar-text)';
  }
}

// â•â• STATE â•â•
let searchQ='', filterSev='', filterStatus='';

// ìƒì‚°ìˆ˜ëŸ‰ ë°ì´í„° { 'YYYY-MM': qty }
let productionData = {};
let uploadedPhotos=[];

// â•â• NAVIGATION â•â•
const pageInfo = {
  home:    { title:'ğŸ“Š ëŒ€ì‹œë³´ë“œ',        sub:'í’ˆì§ˆ í˜„í™© Â· 2025ë…„ 2ì›”' },
  defects: { title:'ğŸ”´ ë¶ˆëŸ‰ ê´€ë¦¬',       sub:'ë“±ë¡ ë° ì¶”ì ' },
  report:  { title:'ğŸ“„ ì›”ê°„ ë³´ê³ ì„œ',     sub:'2025ë…„ 2ì›” í’ˆì§ˆ ì‹¤ì ' },
};

function goPage(name, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(el) el.classList.add('active');
  else { const nav = document.querySelector(`[onclick*="'${name}'"]`); if(nav) nav.classList.add('active'); }
  document.getElementById('page-title').textContent = pageInfo[name].title;
  document.getElementById('page-sub').textContent   = pageInfo[name].sub;
  if(name==='defects') renderTable();
  if(name==='home')    renderDashboard();
  if(name==='report')  renderReport();
  setMobTab(name);
}

// â•â• HOME â•â•
// â•â• ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ë¶ˆëŸ‰ ë°ì´í„° ì‹¤ì‹œê°„ ì—°ë™) â•â•
function renderDashboard() {
  const now    = new Date();
  const thisYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const label  = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›”`;

  // ë‹¹ì›” ë°ì´í„°
  const monthData = defects.filter(d => (d.date||'').startsWith(thisYM));

  // ì „ì›” ë¹„êµ
  const prevD  = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const prevYM = `${prevD.getFullYear()}-${String(prevD.getMonth()+1).padStart(2,'0')}`;
  const prevMonth = defects.filter(d => (d.date||'').startsWith(prevYM));
  const diff   = monthData.length - prevMonth.length;

  // ê³ ê°ì‚¬ ë¶ˆëŸ‰ (HMI 1 + HMI 2)
  const customerDefects = monthData.filter(d => d.occurrence === 'HMI 1' || d.occurrence === 'HMI 2');
  // ì‚¬ë‚´ ë¶ˆëŸ‰ (ìˆ˜ì…ê²€ì‚¬+í”„ë ˆìŠ¤ë¼ì¸+ì¡°ë¦½ë¼ì¸+PDI)
  const internalOcc = ['ìˆ˜ì…ê²€ì‚¬','í”„ë ˆìŠ¤ë¼ì¸','ì¡°ë¦½ë¼ì¸','PDI'];
  const internalDefects = monthData.filter(d => internalOcc.includes(d.occurrence));

  // ìƒì‚°ìˆ˜ëŸ‰
  const prodQty = productionData[thisYM] || 0;

  // PPM ê³„ì‚° (ë¶ˆëŸ‰ìˆ˜ëŸ‰ í•©ê³„ ê¸°ì¤€)
  const customerQty  = customerDefects.reduce((s,d)=>s+Number(d.qty||0),0);
  const internalQty  = internalDefects.reduce((s,d)=>s+Number(d.qty||0),0);
  const customerPPM  = prodQty > 0 ? Math.round(customerQty / prodQty * 1000000) : null;
  const internalPPM  = prodQty > 0 ? Math.round(internalQty / prodQty * 1000000) : null;

  const ppmStr  = (val) => val === null ? 'ìƒì‚°ìˆ˜ëŸ‰ ë¯¸ì…ë ¥' : val.toLocaleString();

  // KPI ë Œë”ë§
  document.getElementById('kpi-total').textContent        = monthData.length + 'ê±´';
  document.getElementById('kpi-total-sub').textContent    = `${label} Â· ì „ì›” ëŒ€ë¹„ ${diff>0?'â–²+'+diff:diff<0?'â–¼'+diff:'â”€'} ê±´`;
  document.getElementById('kpi-closed-rate').textContent  = customerDefects.length + 'ê±´';
  document.getElementById('kpi-closed-sub').textContent   = `HMI 1: ${monthData.filter(d=>d.occurrence==='HMI 1').length}ê±´ Â· HMI 2: ${monthData.filter(d=>d.occurrence==='HMI 2').length}ê±´`;
  document.getElementById('kpi-thismonth').textContent    = customerPPM === null ? '-' : customerPPM.toLocaleString();
  document.getElementById('kpi-thismonth-sub').textContent = prodQty > 0 ? `ìƒì‚° ${prodQty.toLocaleString()}ê°œ ê¸°ì¤€` : 'ìƒì‚°ìˆ˜ëŸ‰ ë¯¸ì…ë ¥';
  document.getElementById('kpi-open').textContent         = internalPPM === null ? '-' : internalPPM.toLocaleString();
  document.getElementById('kpi-open-sub').textContent     = prodQty > 0 ? `ì‚¬ë‚´ ë¶ˆëŸ‰ ${internalQty}ê°œ ê¸°ì¤€` : 'ìƒì‚°ìˆ˜ëŸ‰ ë¯¸ì…ë ¥';

  // ìƒì‚°ìˆ˜ëŸ‰ ì…ë ¥ UI (ëŒ€ì‹œë³´ë“œ ìƒë‹¨)
  const prodWrap = document.getElementById('prod-qty-wrap');
  if (prodWrap) {
    prodWrap.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-size:13px;color:var(--text-muted);font-weight:600;">ğŸ“¦ ${label} ìƒì‚°ìˆ˜ëŸ‰</span>
        <input type="number" id="prod-qty-input" value="${prodQty||''}" placeholder="ìƒì‚°ìˆ˜ëŸ‰ ì…ë ¥"
          style="width:140px;padding:6px 10px;border:1px solid var(--border-dark);border-radius:8px;font-size:13px;font-family:'DM Mono',monospace;">
        <button class="btn btn-primary btn-sm" onclick="saveProdQtyFromInput()">ì €ì¥</button>
        ${prodQty > 0 ? `<span style="font-size:12px;color:var(--success);font-weight:600;">âœ… ${prodQty.toLocaleString()}ê°œ ë“±ë¡ë¨</span>` : `<span style="font-size:12px;color:var(--danger);">âš ï¸ ë¯¸ì…ë ¥ ì‹œ PPM ê³„ì‚° ë¶ˆê°€</span>`}
      </div>`;
  }

  // ê³µí†µ ìƒ‰ìƒ
  const typeColors  = ['#e02424','#d97706','#7c3aed','#1a56db','#057a55','#0891b2','#9aa5b4'];
  const occColorMap = {'ìˆ˜ì…ê²€ì‚¬':'#1a56db','í”„ë ˆìŠ¤ë¼ì¸':'#d97706','ì¡°ë¦½ë¼ì¸':'#7c3aed','PDI':'#057a55','HMI 1':'#e02424','HMI 2':'#0891b2','ê¸°íƒ€':'#9aa5b4'};
  const ownerColors = ['#057a55','#e02424','#d97706','#1a56db','#7c3aed','#0891b2','#9aa5b4'];
  const modelColors = ['#1a56db','#7c3aed','#0891b2','#d97706','#057a55','#e02424','#9aa5b4'];
  const itemColors  = ['#0891b2','#7c3aed','#d97706','#057a55','#e02424','#1a56db','#9aa5b4'];

  function groupBy(arr, key) {
    const map = {};
    arr.forEach(d => { const k = d[key]||'-'; map[k] = (map[k]||0)+1; });
    return Object.entries(map).sort((a,b) => b[1]-a[1]);
  }

  function renderBar(elId, arr, colorFn) {
    const max = arr[0]?.[1] || 1;
    document.getElementById(elId).innerHTML = arr.length
      ? arr.map(([k,cnt],i) => `
        <div class="bar-row">
          <div class="bar-lbl">${k}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${Math.round(cnt/max*100)}%;background:${colorFn(k,i)};transition:width 0.6s ease;"></div></div>
          <div class="bar-num">${cnt}ê±´</div>
        </div>`).join('')
      : '<div style="color:var(--text-muted);font-size:13px;padding:24px 0;text-align:center;">ë‹¹ì›” ë°ì´í„° ì—†ìŒ</div>';
  }

  function renderDonut(elId, arr, colors) {
    const tot = arr.reduce((s,[,v])=>s+v,0);
    if (!arr.length) { document.getElementById(elId).innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:40px 0;text-align:center;">ë‹¹ì›” ë°ì´í„° ì—†ìŒ</div>'; return; }
    const cx=100,cy=100,R=80,r=50;
    let startAngle = -Math.PI/2, slices = '';
    arr.forEach(([type,cnt],i) => {
      const angle = (cnt/tot)*2*Math.PI;
      const x1=cx+R*Math.cos(startAngle), y1=cy+R*Math.sin(startAngle);
      const x2=cx+R*Math.cos(startAngle+angle), y2=cy+R*Math.sin(startAngle+angle);
      const ix1=cx+r*Math.cos(startAngle), iy1=cy+r*Math.sin(startAngle);
      const ix2=cx+r*Math.cos(startAngle+angle), iy2=cy+r*Math.sin(startAngle+angle);
      const large = angle > Math.PI ? 1 : 0;
      const color = colors[i%colors.length];
      const midA  = startAngle + angle/2;
      const lx=cx+(R+14)*Math.cos(midA), ly=cy+(R+14)*Math.sin(midA);
      const pct = Math.round(cnt/tot*100);
      slices += `<path d="M${x1},${y1} A${R},${R} 0 ${large},1 ${x2},${y2} L${ix2},${iy2} A${r},${r} 0 ${large},0 ${ix1},${iy1} Z" fill="${color}" opacity="0.9"/>`;
      if (pct >= 5) slices += `<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="${color}" font-size="10" font-weight="700" font-family="DM Mono">${pct}%</text>`;
      startAngle += angle;
    });
    slices += `<text x="${cx}" y="${cy-7}" text-anchor="middle" fill="var(--text)" font-size="11" font-family="Noto Sans KR">ë‹¹ì›”</text>`;
    slices += `<text x="${cx}" y="${cy+10}" text-anchor="middle" fill="var(--text)" font-size="18" font-weight="700" font-family="DM Mono">${tot}</text>`;
    slices += `<text x="${cx}" y="${cy+26}" text-anchor="middle" fill="var(--text-muted)" font-size="10" font-family="Noto Sans KR">ê±´</text>`;
    const legend = arr.map(([type,cnt],i)=>`
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px;">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${colors[i%colors.length]};flex-shrink:0;"></span>
        <span style="flex:1;color:var(--text);">${type}</span>
        <span style="font-family:'DM Mono',monospace;color:var(--text-muted);">${cnt}ê±´</span>
      </div>`).join('');
    document.getElementById(elId).innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;">
        <svg viewBox="0 0 200 200" width="160" height="160" style="flex-shrink:0;">${slices}</svg>
        <div style="flex:1;">${legend}</div>
      </div>`;
  }

  // ì°¨íŠ¸ ë Œë”ë§ (ëª¨ë‘ ë‹¹ì›” ê¸°ì¤€)
  renderDonut('chart-type', groupBy(monthData,'type'), typeColors);
  renderBar('chart-model',      groupBy(monthData,'carModel'),   (k,i)=>modelColors[i%modelColors.length]);
  renderBar('chart-occurrence', groupBy(monthData,'occurrence'), (k)=>occColorMap[k]||'#9aa5b4');
  renderBar('chart-owner',      groupBy(monthData,'owner'),      (k,i)=>ownerColors[i%ownerColors.length]);
  renderBar('chart-item',       groupBy(monthData,'item'),       (k,i)=>itemColors[i%itemColors.length]);

  // card-sub ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
  ['chart-model','chart-occurrence','chart-owner','chart-item'].forEach(id => {
    const card = document.getElementById(id).closest('.card');
    if (card) { const sub = card.querySelector('.card-sub'); if(sub) sub.textContent = label + ' ê¸°ì¤€'; }
  });

  // ì£¼ë³„ ì¶”ì´ (ë‹¹ì›”)
  renderTrendSVG(buildWeeks(now));
  renderOccurrenceTrend(now);
}

// â”€â”€ ë‹¹ì›” ì£¼ ëª©ë¡ ìƒì„± (ì›”ìš”ì¼ ê¸°ì¤€, í•´ë‹¹ ì›”ì— ì†í•˜ëŠ” ì£¼ë§Œ)
function buildWeeks(now) {
  const year  = now.getFullYear();
  const month = now.getMonth(); // 0-based
  const firstDay = new Date(year, month, 1);
  const lastDay  = new Date(year, month + 1, 0);

  // ì²« ë²ˆì§¸ ì›”ìš”ì¼ ì°¾ê¸° (ì›” ì‹œì‘ì¼ ì´ì „ í¬í•¨)
  const firstMon = new Date(firstDay);
  const dow = firstDay.getDay(); // 0=ì¼
  firstMon.setDate(firstDay.getDate() - (dow === 0 ? 6 : dow - 1));

  const weeks = [];
  let weekNum = 1;
  let mon = new Date(firstMon);

  while (mon <= lastDay) {
    const sun = new Date(mon);
    sun.setDate(sun.getDate() + 6);

    // ì‹¤ì œ í•´ë‹¹ ì£¼ì˜ ì‹œì‘/ë (ì›” ë²”ìœ„ë¡œ í´ë¨í”„)
    const rangeStart = mon < firstDay ? firstDay : mon;
    const rangeEnd   = sun > lastDay  ? lastDay  : sun;

    const monStr = mon.toISOString().slice(0, 10);
    const sunStr = sun.toISOString().slice(0, 10);

    const cnt = defects.filter(d => {
      const dt = (d.date || '').slice(0, 10);
      return dt >= monStr && dt <= sunStr;
    }).length;

    weeks.push({
      label:   `${weekNum}ì£¼`,
      monStr,
      sunStr,
      cnt
    });

    weekNum++;
    mon.setDate(mon.getDate() + 7);
  }
  return weeks;
}

function renderTrendSVG(weeks) {
  const svg = document.getElementById('trend-svg');
  if (!svg) return;
  const n = weeks.length;
  if (n < 2) {
    svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="#9aa5b4" font-size="13" font-family="Noto Sans KR" dominant-baseline="middle">ë°ì´í„° ì—†ìŒ</text>`;
    return;
  }
  const W = 870, H = 100, padT = 14, padB = 20;
  const maxVal = Math.max(...weeks.map(w => w.cnt), 1);
  const xs     = weeks.map((_, i) => Math.round(i / (n - 1) * W));
  const ys     = weeks.map(w => Math.round(padT + (1 - w.cnt / maxVal) * (H - padT - padB)));
  const pts    = xs.map((x, i) => `${x},${ys[i]}`).join(' ');
  const fill   = `${xs[0]},${H} ${pts} ${xs[n-1]},${H}`;

  svg.innerHTML = `
    <defs>
      <linearGradient id="tg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#1a56db" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="#1a56db" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <line x1="0" y1="${Math.round(H*0.3)}"  x2="${W}" y2="${Math.round(H*0.3)}"  stroke="#e4e9f0" stroke-dasharray="4"/>
    <line x1="0" y1="${Math.round(H*0.62)}" x2="${W}" y2="${Math.round(H*0.62)}" stroke="#e4e9f0" stroke-dasharray="4"/>
    <polygon points="${fill}" fill="url(#tg)"/>
    <polyline points="${pts}" fill="none" stroke="#1a56db" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    ${xs.map((x, i) => `
      <circle cx="${x}" cy="${ys[i]}" r="${i===n-1?5:3.5}" fill="#1a56db" ${i===n-1?'stroke="#fff" stroke-width="2"':''}/>
      <text x="${x}" y="${ys[i]-8}" fill="#1a56db" font-size="9" font-weight="700"
        text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${weeks[i].cnt}</text>
      <text x="${x}" y="${H}" fill="${i===n-1?'#1a56db':'#9aa5b4'}" font-size="10"
        text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${weeks[i].label}</text>
    `).join('')}`;
}

function renderOccurrenceTrend(now) {
  const wrap = document.getElementById('occ-charts-wrap');
  if (!wrap) return;

  const occColorMap = {'ìˆ˜ì…ê²€ì‚¬':'#1a56db','í”„ë ˆìŠ¤ë¼ì¸':'#d97706','ì¡°ë¦½ë¼ì¸':'#7c3aed','PDI':'#057a55','HMI 1':'#e02424','HMI 2':'#0891b2','ê¸°íƒ€':'#9aa5b4'};
  const ALL_OCC = ['ìˆ˜ì…ê²€ì‚¬','í”„ë ˆìŠ¤ë¼ì¸','ì¡°ë¦½ë¼ì¸','PDI','HMI 1','HMI 2'];

  // ë‹¹ì›” ì£¼ ëª©ë¡
  const weeks = buildWeeks(now);
  const n = weeks.length;
  const W = 440, H = 110, padT = 20, padB = 22, padL = 5, padR = 15;

  wrap.innerHTML = ALL_OCC.map(occ => {
    const color  = occColorMap[occ] || '#9aa5b4';
    const counts = weeks.map(w =>
      defects.filter(d => {
        const dt = (d.date || '').slice(0, 10);
        return dt >= w.monStr && dt <= w.sunStr && d.occurrence === occ;
      }).length
    );
    const total  = counts.reduce((a, b) => a + b, 0);
    const maxVal = Math.max(...counts, 1);
    const xs     = n < 2
      ? counts.map((_, i) => Math.round(padL + i / Math.max(n-1,1) * (W - padL - padR)))
      : counts.map((_, i) => Math.round(padL + i / (n-1) * (W - padL - padR)));
    const ys     = counts.map(cnt => Math.round(padT + (1 - cnt / maxVal) * (H - padT - padB)));
    const pts    = xs.map((x, i) => `${x},${ys[i]}`).join(' ');
    const fill   = `${xs[0]},${H-padB} ${pts} ${xs[n-1]},${H-padB}`;

    const gridLines = [0.3, 0.65].map(r =>
      `<line x1="${padL}" y1="${Math.round(padT + r*(H-padT-padB))}" x2="${W-padR}" y2="${Math.round(padT + r*(H-padT-padB))}" stroke="#e4e9f0" stroke-dasharray="3"/>`
    ).join('');

    const dots = xs.map((x, i) => `
      <circle cx="${x}" cy="${ys[i]}" r="3.5" fill="${color}" stroke="#fff" stroke-width="1.5"/>
      <text x="${x}" y="${ys[i]-8}" fill="${color}" font-size="10" font-weight="700"
        text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${counts[i]}</text>
      <text x="${x}" y="${H}" fill="${i===n-1?color:'#9aa5b4'}" font-size="10"
        text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${weeks[i].label}</text>
    `).join('');

    return `
      <div style="background:var(--bg);border-radius:10px;padding:14px 16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div style="display:flex;align-items:center;gap:7px;">
            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};"></span>
            <span style="font-size:13px;font-weight:700;color:var(--text);">${occ}</span>
          </div>
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:${total>0?color:'var(--text-muted)'};font-weight:700;">ë‹¹ì›” ${total}ê±´</span>
        </div>
        <svg width="100%" height="${H}" viewBox="-5 0 ${W+10} ${H}" preserveAspectRatio="none">
          ${gridLines}
          <polygon points="${fill}" fill="${color}" opacity="${total>0?'0.08':'0.03'}"/>
          <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="${total>0?'1':'0.3'}"/>
          ${dots}
        </svg>
      </div>`;
  }).join('');
}

// â•â• ì›”ê°„ ë³´ê³ ì„œ ë Œë”ë§ â•â•
let reportYear  = new Date().getFullYear();
let reportMonth = new Date().getMonth() + 1;

function changeReportMonth(dir) {
  reportMonth += dir;
  if (reportMonth > 12) { reportMonth = 1;  reportYear++; }
  if (reportMonth < 1)  { reportMonth = 12; reportYear--; }
  renderReport();
}

function renderReport() {
  const ym     = `${reportYear}-${String(reportMonth).padStart(2,'0')}`;
  const prevD  = new Date(reportYear, reportMonth - 2, 1);
  const prevYM = `${prevD.getFullYear()}-${String(prevD.getMonth()+1).padStart(2,'0')}`;
  const label  = `${reportYear}ë…„ ${reportMonth}ì›”`;

  const curr   = defects.filter(d => (d.date||'').startsWith(ym));
  const prev   = defects.filter(d => (d.date||'').startsWith(prevYM));
  const closed = curr.filter(d => d.status === 'closed');
  const open   = curr.filter(d => d.status === 'open');
  const rate   = curr.length ? Math.round(closed.length / curr.length * 100) : 0;
  const diff   = curr.length - prev.length;

  document.getElementById('report-month-label').textContent = label;

  // KPI
  document.getElementById('r-total').textContent      = curr.length + 'ê±´';
  document.getElementById('r-total-sub').textContent  = `ì „ì²´ ëˆ„ê³„ ${defects.length}ê±´ ì¤‘`;
  document.getElementById('r-closed-rate').textContent = rate + '%';
  document.getElementById('r-closed-sub').textContent  = `ì™„ë£Œ ${closed.length}ê±´ / ë‹¹ì›” ${curr.length}ê±´`;
  document.getElementById('r-open').textContent       = open.length + 'ê±´';
  document.getElementById('r-open-sub').textContent   = open.length > 0 ? 'ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”' : 'âœ… ëª¨ë‘ ì²˜ë¦¬ ì™„ë£Œ';
  const diffEl = document.getElementById('r-diff');
  diffEl.textContent = (diff > 0 ? 'â–² +' : diff < 0 ? 'â–¼ ' : 'â”€ ') + diff + 'ê±´';
  diffEl.style.color = diff > 0 ? 'var(--danger)' : diff < 0 ? 'var(--success)' : 'var(--text-muted)';
  document.getElementById('r-diff-sub').textContent = `ì „ì›”(${prevD.getMonth()+1}ì›”) ${prev.length}ê±´ ëŒ€ë¹„`;

  // ìƒ‰ìƒ
  const typeColors  = ['#e02424','#d97706','#7c3aed','#1a56db','#057a55','#0891b2','#9aa5b4'];
  const occColorMap = {'ìˆ˜ì…ê²€ì‚¬':'#1a56db','í”„ë ˆìŠ¤ë¼ì¸':'#d97706','ì¡°ë¦½ë¼ì¸':'#7c3aed','PDI':'#057a55','HMI 1':'#e02424','HMI 2':'#0891b2','ê¸°íƒ€':'#9aa5b4'};
  const ownerColors = ['#057a55','#e02424','#d97706','#1a56db','#7c3aed','#0891b2','#9aa5b4'];
  const modelColors = ['#1a56db','#7c3aed','#0891b2','#d97706','#057a55','#e02424','#9aa5b4'];

  function groupBy(arr, key) {
    const map = {};
    arr.forEach(d => { const k = d[key]||'-'; map[k]=(map[k]||0)+1; });
    return Object.entries(map).sort((a,b) => b[1]-a[1]);
  }

  function renderBar(elId, subId, arr, colorFn, subText) {
    if(subId) document.getElementById(subId).textContent = subText || label + ' ê¸°ì¤€';
    const max = arr[0]?.[1] || 1;
    document.getElementById(elId).innerHTML = arr.length
      ? arr.map(([k,cnt],i) => `
        <div class="bar-row">
          <div class="bar-lbl">${k}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${Math.round(cnt/max*100)}%;background:${colorFn(k,i)};transition:width 0.6s ease;"></div></div>
          <div class="bar-num">${cnt}ê±´</div>
        </div>`).join('')
      : '<div style="color:var(--text-muted);font-size:13px;padding:24px 0;text-align:center;">ë‹¹ì›” ë°ì´í„° ì—†ìŒ</div>';
  }

  // ë¶ˆëŸ‰ ìœ í˜• ë„ë„› ì°¨íŠ¸
  const typeArr = groupBy(curr, 'type');
  const typeTot = typeArr.reduce((s,[,v])=>s+v, 0);
  document.getElementById('r-type-sub').textContent = label + ' ê¸°ì¤€';
  if (!typeArr.length) {
    document.getElementById('r-chart-type').innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:40px 0;text-align:center;">ë‹¹ì›” ë°ì´í„° ì—†ìŒ</div>';
  } else {
    const cx=100,cy=100,R=80,r=50;
    let sa=-Math.PI/2, slices='';
    typeArr.forEach(([type,cnt],i) => {
      const angle=(cnt/typeTot)*2*Math.PI;
      const x1=cx+R*Math.cos(sa),y1=cy+R*Math.sin(sa);
      const x2=cx+R*Math.cos(sa+angle),y2=cy+R*Math.sin(sa+angle);
      const ix1=cx+r*Math.cos(sa),iy1=cy+r*Math.sin(sa);
      const ix2=cx+r*Math.cos(sa+angle),iy2=cy+r*Math.sin(sa+angle);
      const lg=angle>Math.PI?1:0, col=typeColors[i%typeColors.length];
      const midA=sa+angle/2, lx=cx+(R+14)*Math.cos(midA), ly=cy+(R+14)*Math.sin(midA);
      const pct=Math.round(cnt/typeTot*100);
      slices+=`<path d="M${x1},${y1} A${R},${R} 0 ${lg},1 ${x2},${y2} L${ix2},${iy2} A${r},${r} 0 ${lg},0 ${ix1},${iy1} Z" fill="${col}" opacity="0.9"/>`;
      if(pct>=5) slices+=`<text x="${lx}" y="${ly}" text-anchor="middle" dominant-baseline="middle" fill="${col}" font-size="10" font-weight="700" font-family="DM Mono">${pct}%</text>`;
      sa+=angle;
    });
    slices+=`<text x="${cx}" y="${cy-7}" text-anchor="middle" fill="var(--text)" font-size="11" font-family="Noto Sans KR">ë‹¹ì›”</text>`;
    slices+=`<text x="${cx}" y="${cy+10}" text-anchor="middle" fill="var(--text)" font-size="18" font-weight="700" font-family="DM Mono">${typeTot}</text>`;
    slices+=`<text x="${cx}" y="${cy+26}" text-anchor="middle" fill="var(--text-muted)" font-size="10" font-family="Noto Sans KR">ê±´</text>`;
    const legend=typeArr.map(([t,cnt],i)=>`
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;margin-bottom:6px;">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${typeColors[i%typeColors.length]};flex-shrink:0;"></span>
        <span style="flex:1;color:var(--text);">${t}</span>
        <span style="font-family:'DM Mono',monospace;color:var(--text-muted);">${cnt}ê±´</span>
      </div>`).join('');
    document.getElementById('r-chart-type').innerHTML=`
      <div style="display:flex;align-items:center;gap:16px;">
        <svg viewBox="0 0 200 200" width="160" height="160" style="flex-shrink:0;">${slices}</svg>
        <div style="flex:1;">${legend}</div>
      </div>`;
  }

  renderBar('r-chart-occ',   'r-occ-sub',   groupBy(curr,'occurrence'), (k)   => occColorMap[k]||'#9aa5b4');
  renderBar('r-chart-model', 'r-model-sub', groupBy(curr,'carModel'),   (k,i) => modelColors[i%modelColors.length]);
  renderBar('r-chart-owner', 'r-owner-sub', groupBy(curr,'owner'),      (k,i) => ownerColors[i%ownerColors.length]);

  // í•´ë‹¹ ì—°ë„ 12ê°œì›” ì¶”ì´ SVG
  const yearMonths = [];
  for (let m=1; m<=12; m++) {
    const ymStr = `${reportYear}-${String(m).padStart(2,'0')}`;
    yearMonths.push({ label:`${m}ì›”`, ym:ymStr, cnt: defects.filter(d=>(d.date||'').startsWith(ymStr)).length });
  }
  document.getElementById('r-trend-sub').textContent = `${reportYear}ë…„ ì›”ë³„ í˜„í™©`;

  const rSvg = document.getElementById('r-trend-svg');
  if (rSvg) {
    const W=870, H=100, padT=14, padB=20;
    const maxVal = Math.max(...yearMonths.map(m=>m.cnt), 1);
    const n=yearMonths.length;
    const xs = yearMonths.map((_,i) => Math.round(i/(n-1)*W));
    const ys = yearMonths.map(m => Math.round(padT + (1-m.cnt/maxVal)*(H-padT-padB)));
    const pts = xs.map((x,i)=>`${x},${ys[i]}`).join(' ');
    const fill = `${xs[0]},${H} ${pts} ${xs[n-1]},${H}`;
    rSvg.innerHTML = `
      <defs><linearGradient id="rtg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#1a56db" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="#1a56db" stop-opacity="0"/>
      </linearGradient></defs>
      <line x1="0" y1="${Math.round(H*0.3)}" x2="${W}" y2="${Math.round(H*0.3)}" stroke="#e4e9f0" stroke-dasharray="4"/>
      <line x1="0" y1="${Math.round(H*0.62)}" x2="${W}" y2="${Math.round(H*0.62)}" stroke="#e4e9f0" stroke-dasharray="4"/>
      <polygon points="${fill}" fill="url(#rtg)"/>
      <polyline points="${pts}" fill="none" stroke="#1a56db" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      ${xs.map((x,i)=>`
        <circle cx="${x}" cy="${ys[i]}" r="${i===reportMonth-1?6:3.5}" fill="#1a56db"
          ${i===reportMonth-1?'stroke="#fff" stroke-width="2"':''}/>
        ${yearMonths[i].cnt>0?`<text x="${x}" y="${ys[i]-8}" fill="#1a56db" font-size="9" font-weight="700"
          text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${yearMonths[i].cnt}</text>`:''}
        <text x="${x}" y="${H}" fill="${i===reportMonth-1?'#1a56db':'#9aa5b4'}" font-size="10"
          font-weight="${i===reportMonth-1?'700':'400'}"
          text-anchor="${i===0?'start':i===n-1?'end':'middle'}" font-family="DM Mono">${yearMonths[i].label}</text>
      `).join('')}`;
  }

  // ë°œìƒì²˜ë³„ ê°œë³„ ì¶”ì´ (í•´ë‹¹ ì—°ë„ 12ê°œì›”)
  document.getElementById('r-occ-trend-sub').textContent = `${reportYear}ë…„ ë°œìƒì²˜ë³„ ì›”ë³„ í˜„í™©`;
  const rOccWrap = document.getElementById('r-occ-charts-wrap');
  const occSet = [...new Set(defects.map(d=>d.occurrence||'').filter(Boolean))];
  if (!occSet.length) { rOccWrap.innerHTML='<div style="color:var(--text-muted);font-size:13px;padding:16px;text-align:center;">ë°ì´í„° ì—†ìŒ</div>'; }
  else {
    const W2=440, H2=110, padT2=20, padB2=22, padL=5, padR=15, n2=12;
    rOccWrap.innerHTML = occSet.map(occ => {
      const color  = occColorMap[occ]||'#9aa5b4';
      const counts = yearMonths.map(m => defects.filter(d=>(d.date||'').startsWith(m.ym)&&d.occurrence===occ).length);
      const maxV   = Math.max(...counts,1);
      const xs2    = yearMonths.map((_,i) => Math.round(padL + i/(n2-1)*(W2-padL-padR)));
      const ys2    = counts.map(cnt => Math.round(padT2+(1-cnt/maxV)*(H2-padT2-padB2)));
      const pts2   = xs2.map((x,i)=>`${x},${ys2[i]}`).join(' ');
      const fill2  = `${xs2[0]},${H2-padB2} ${pts2} ${xs2[n2-1]},${H2-padB2}`;
      const total2 = counts.reduce((a,b)=>a+b,0);
      const gridL  = [0.3,0.65].map(r=>`<line x1="${padL}" y1="${Math.round(padT2+r*(H2-padT2-padB2))}" x2="${W2-padR}" y2="${Math.round(padT2+r*(H2-padT2-padB2))}" stroke="#e4e9f0" stroke-dasharray="3"/>`).join('');
      const dots   = xs2.map((x,i)=>`
        <circle cx="${x}" cy="${ys2[i]}" r="${i===reportMonth-1?5:3}" fill="${color}" stroke="#fff" stroke-width="${i===reportMonth-1?2:1}"/>
        ${counts[i]>0?`<text x="${x}" y="${ys2[i]-8}" fill="${color}" font-size="9" font-weight="700"
          text-anchor="${i===0?'start':i===n2-1?'end':'middle'}" font-family="DM Mono">${counts[i]}</text>`:''}
        <text x="${x}" y="${H2}" fill="${i===reportMonth-1?color:'#9aa5b4'}" font-size="9"
          font-weight="${i===reportMonth-1?'700':'400'}"
          text-anchor="${i===0?'start':i===n2-1?'end':'middle'}" font-family="DM Mono">${yearMonths[i].label}</text>
      `).join('');
      return `
        <div style="background:var(--bg);border-radius:10px;padding:14px 16px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:7px;">
              <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};"></span>
              <span style="font-size:13px;font-weight:700;color:var(--text);">${occ}</span>
            </div>
            <span style="font-size:12px;font-family:'DM Mono',monospace;color:${color};font-weight:700;">ì—°ê°„ ${total2}ê±´</span>
          </div>
          <svg width="100%" height="${H2}" viewBox="-5 0 ${W2+10} ${H2}" preserveAspectRatio="none">
            ${gridL}
            <polygon points="${fill2}" fill="${color}" opacity="0.08"/>
            <polyline points="${pts2}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            ${dots}
          </svg>
        </div>`;
    }).join('');
  }

  // ë‹¹ì›” ë¶ˆëŸ‰ ëª©ë¡
  document.getElementById('r-list-sub').textContent = `${ym} ë“±ë¡ Â· ${curr.length}ê±´`;
  const statusKo = { open:'ë¯¸ì²˜ë¦¬', closed:'ì™„ë£Œ' };
  document.getElementById('r-tbody').innerHTML = curr.length
    ? [...curr].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(d=>`
        <tr>
          <td>${d.carModel||'-'}</td>
          <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);">${d.partNo||'-'}</td>
          <td style="font-weight:600;">${d.item}</td>
          <td>${d.type}</td>
          <td>${d.occurrence||'-'}</td>
          <td style="font-family:'DM Mono',monospace;">${d.qty||'-'}</td>
          <td>${d.owner||'-'}</td>
          <td style="font-family:'DM Mono',monospace;font-size:11px;">${(d.date||'').slice(0,10)}</td>
          <td><span class="badge ${d.status}">${statusKo[d.status]||d.status}</span></td>
        </tr>`).join('')
    : '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:20px;">ë‹¹ì›” ë¶ˆëŸ‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';

  // ì¢…í•© ì˜ê²¬
  const topType  = groupBy(curr,'type')[0]?.[0]  || '-';
  const topModel = groupBy(curr,'carModel')[0]?.[0] || '-';
  const topOcc   = groupBy(curr,'occurrence')[0]?.[0] || '-';
  const openRate = curr.length ? Math.round(open.length/curr.length*100) : 0;
  document.getElementById('r-summary').innerHTML = `
    <strong style="color:var(--text);">ğŸ’¡ ${label} ì¢…í•© ì˜ê²¬</strong><br><br>
    ë‹¹ì›” ì´ <strong>${curr.length}ê±´</strong>ì˜ ë¶ˆëŸ‰ì´ ë“±ë¡ë˜ì—ˆìœ¼ë©°,
    ì™„ë£Œ ì²˜ë¦¬ìœ¨ì€ <strong style="color:${rate>=80?'var(--success)':'var(--danger)'};">${rate}%</strong>ì…ë‹ˆë‹¤.
    ${diff>0?`ì „ì›” ëŒ€ë¹„ <strong style="color:var(--danger);">+${diff}ê±´ ì¦ê°€</strong>í•˜ì˜€ìœ¼ë¯€ë¡œ ì›ì¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.`
    :diff<0?`ì „ì›” ëŒ€ë¹„ <strong style="color:var(--success);">${diff}ê±´ ê°ì†Œ</strong>í•˜ì—¬ ê°œì„  ì¶”ì„¸ì…ë‹ˆë‹¤.`
    :`ì „ì›”ê³¼ ë™ì¼í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.`}
    ${curr.length>0?`<br><br>
    ğŸ“Œ <strong>ì£¼ìš” í˜„í™©:</strong><br>
    Â· ìµœë‹¤ ë¶ˆëŸ‰ ìœ í˜•: <strong>${topType}</strong><br>
    Â· ìµœë‹¤ ë°œìƒ ëª¨ë¸: <strong>${topModel}</strong><br>
    Â· ì£¼ìš” ë°œìƒì²˜: <strong>${topOcc}</strong><br>
    ${open.length>0?`Â· <span style="color:var(--danger);">ë¯¸ì²˜ë¦¬ ${open.length}ê±´(${openRate}%) ì¡°ì†í•œ ì¡°ì¹˜ í•„ìš”</span>`:'Â· âœ… ë‹¹ì›” ë¶ˆëŸ‰ ì „ê±´ ì²˜ë¦¬ ì™„ë£Œ'}`:''}`;
}


function renderHomeDefects() {
  const el = document.getElementById('home-defects');
  if (!el) return;
  el.innerHTML = defects.slice(0,4).map(d=>`
    <div onclick="openDetail('${d.partNo}')" style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;">
      <span class="badge ${d.status}" style="flex-shrink:0;">${d.status==='open'?'ë¯¸ì²˜ë¦¬':'ì™„ë£Œ'}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.item} <span style="font-weight:400;color:var(--text-muted);">(${d.carModel||'-'})</span></div>
        <div style="font-size:11px;color:var(--text-muted);">${d.type} Â· ${d.occurrence}</div>
      </div>
      <span style="font-size:11px;font-family:'DM Mono',monospace;color:var(--text-light);flex-shrink:0;">${(d.date||"").slice(0,10)}</span>
    </div>`).join('');
}

// â•â• TABLE â•â•
function getFiltered() {
  return defects.filter(d=>{
    const qOk  = !searchQ      || Object.values(d).join(' ').toLowerCase().includes(searchQ.toLowerCase());
    const sOk  = !filterSev    || d.occurrence===filterSev;
    const stOk = !filterStatus || d.status===filterStatus;
    return qOk && sOk && stOk;
  });
}

function renderTable() {
  const list=getFiltered(), tbody=document.getElementById('defect-tbody');
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">ğŸ”</div><p>í•´ë‹¹í•˜ëŠ” ë¶ˆëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p></div></td></tr>`; return; }
  tbody.innerHTML=list.map((d,i)=>`
    <tr data-partno="${encodeURIComponent(d.partNo)}" class="defect-row">
      <td style="font-weight:600;">${d.carModel||'-'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);">${d.partNo||'-'}</td>
      <td style="font-weight:600;">${d.item}</td>
      <td>${d.type}</td>
      <td>${d.occurrence||'-'}</td>
      <td style="font-family:'DM Mono',monospace;text-align:center;">${d.qty||'-'}</td>
      <td>${d.owner||'-'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:12px;">${(d.date||'').slice(0,10)}</td>
      <td style="font-size:12px;color:var(--text-muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${d.desc||'-'}</td>
      <td><button class="btn btn-sm edit-btn" data-partno="${encodeURIComponent(d.partNo)}" style="background:var(--accent-light);color:var(--accent);border:1px solid #c7d7ff;">âœï¸ í¸ì§‘</button></td>
    </tr>`).join('');
  updateBadge();

  // í¸ì§‘ ë²„íŠ¼ë§Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  tbody.onclick = function(e) {
    const editBtn = e.target.closest('.edit-btn');
    if (editBtn) {
      openEditModal(decodeURIComponent(editBtn.dataset.partno));
    }
  };
}

function filterDefects(q){searchQ=q;renderTable();}
function filterBySev(v){filterSev=v;renderTable();}
function filterByStatus(v){filterStatus=v;renderTable();}

async function toggleStatus(partNo){
  const d=defects.find(x=>x.partNo===partNo); if(!d) return;
  d.status=d.status==='open'?'closed':'open';
  renderTable(); renderHomeDefects(); updateBadge(); renderDashboard();
  await sheetUpdate(d);
}

function updateBadge(){
  const cnt = defects.filter(d=>d.status==='open').length;
  document.getElementById('open-badge').textContent = cnt;
  const mobBadge = document.getElementById('mob-open-badge');
  if (mobBadge) mobBadge.textContent = cnt > 0 ? cnt : '';
}

// â”€â”€ ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
function saveProdQtyFromInput() {
  const now   = new Date();
  const thisYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const input = document.getElementById('prod-qty-input');
  if (!input) return;
  const qty = Number(input.value);
  if (!qty || qty <= 0) { alert('ìƒì‚°ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  saveProdQty(thisYM, qty);
}

function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const isOpen  = sidebar.classList.contains('open');
  sidebar.classList.toggle('open', !isOpen);
  overlay.classList.toggle('active', !isOpen);
}

// â”€â”€ ëª¨ë°”ì¼ íƒ­ë°” í™œì„±í™”
function setMobTab(name) {
  document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('mob-tab-' + name);
  if (el) el.classList.add('active');
  const sidebar = document.querySelector('.sidebar');
  if (sidebar.classList.contains('open')) toggleSidebar();
}

// â•â• DETAIL â•â•
function openDetail(partNo){
  const d=defects.find(x=>x.partNo===partNo); if(!d) return;
  document.getElementById('detail-body').innerHTML=`
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <span class="badge ${d.status}" style="font-size:12px;">${d.status==='open'?'ë¯¸ì²˜ë¦¬':'ì™„ë£Œ'}</span>
    </div>
    <div class="detail-row"><div class="detail-key">ì°¨ì¢…</div><div class="detail-val">${d.carModel||'-'}</div></div>
    <div class="detail-row"><div class="detail-key">í’ˆë²ˆ</div><div class="detail-val" style="font-family:'DM Mono',monospace;">${d.partNo||'-'}</div></div>
    <div class="detail-row"><div class="detail-key">í’ˆëª©ëª…</div><div class="detail-val">${d.item}</div></div>
    <div class="detail-row"><div class="detail-key">ì‹œë¦¬ì–¼</div><div class="detail-val" style="font-family:'DM Mono',monospace;">${d.serial||'-'}</div></div>
    <div class="detail-row"><div class="detail-key">ë¶ˆëŸ‰ ìœ í˜•</div><div class="detail-val">${d.type}</div></div>
    <div class="detail-row"><div class="detail-key">ë°œìƒì²˜</div><div class="detail-val">${d.occurrence||'-'}</div></div>
    <div class="detail-row"><div class="detail-key">ë¶ˆëŸ‰ ìˆ˜ëŸ‰</div><div class="detail-val">${d.qty||'-'} ea</div></div>
    <div class="detail-row"><div class="detail-key">ê·€ì±…ì²˜</div><div class="detail-val">${d.owner}</div></div>
    <div class="detail-row"><div class="detail-key">ë“±ë¡ì¼</div><div class="detail-val">${(d.date||"").slice(0,10)}</div></div>
    <div class="detail-row"><div class="detail-key">ë¶ˆëŸ‰ ë‚´ìš©</div><div class="detail-val" style="line-height:1.7;">${d.desc}</div></div>
  `;
  const btn=document.getElementById('detail-action-btn');
  btn.textContent=d.status==='open'?'âœ… ì™„ë£Œ ì²˜ë¦¬':'ğŸ”„ ë¯¸ì²˜ë¦¬ë¡œ ë³€ê²½';
  btn.className=d.status==='open'?'btn btn-success':'btn btn-ghost';
  btn.onclick=()=>{ toggleStatus(partNo); closeDetail(); };
  document.getElementById('modal-detail').classList.add('open');
}
function closeDetail(){ document.getElementById('modal-detail').classList.remove('open'); }


// â•â• ë¶ˆëŸ‰ ë“±ë¡ â•â•
function openModal(){
  ['f-carmodel','f-partno','f-item','f-owner','f-desc','f-qty'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  uploadedPhotos=[]; renderPhotoGrid();
  document.getElementById('modal-reg').classList.add('open');
  const fab = document.querySelector('.fab-btn');
  if (fab) fab.style.display = 'none';
}
function closeModal(){
  document.getElementById('modal-reg').classList.remove('open');
  const fab = document.querySelector('.fab-btn');
  if (fab) fab.style.display = '';
}

async function submitDefect(){
  const item=document.getElementById('f-item').value.trim();
  if(!item){ alert('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const d={
    carModel:   document.getElementById('f-carmodel').value||'-',
    partNo:     document.getElementById('f-partno').value||`PN-${Date.now()}`,
    item,
    serial:     '-',
    type:       document.getElementById('f-type').value,
    occurrence: document.getElementById('f-sev').value,
    qty:        document.getElementById('f-qty').value||'-',
    date:       new Date().toISOString().slice(0,10),
    owner:      document.getElementById('f-owner').value||'ë¯¸ì§€ì •',
    status:     'open',
    desc:       document.getElementById('f-desc').value||'-',
    photos:     [...uploadedPhotos],
  };
  defects.unshift(d); uploadedPhotos=[];
  closeModal(); renderHomeDefects(); renderTable(); updateBadge(); renderDashboard();
  await sheetAdd(d);
  showToast('success','ë¶ˆëŸ‰ ë“±ë¡ ì™„ë£Œ',`${d.item} (${d.partNo})${GAS_URL?' Â· Sheets ì €ì¥ë¨':''}`);
}

// â•â• í¸ì§‘ â•â•
let editingId=null;
function openEditModal(id){
  const d=defects.find(x=>x.partNo===id); if(!d) return;
  editingId=id;
  document.getElementById('edit-id-label').textContent=`í’ˆë²ˆ: ${d.partNo}`;
  document.getElementById('e-carmodel').value = d.carModel||'';
  document.getElementById('e-partno').value   = d.partNo||'';
  document.getElementById('e-item').value     = d.item||'';
  document.getElementById('e-qty').value      = d.qty||'';
  document.getElementById('e-owner').value    = d.owner||'';
  document.getElementById('e-desc').value     = d.desc||'';
  document.getElementById('e-date').value     = (d.date||'').slice(0,10);
  setSelectVal('e-type',d.type); setSelectVal('e-sev',d.occurrence);
  setSelectVal('e-status',d.status);
  document.getElementById('modal-edit').classList.add('open');
  const fab = document.querySelector('.fab-btn');
  if (fab) fab.style.display = 'none';
}
function setSelectVal(id,val){
  const sel=document.getElementById(id);
  for(let opt of sel.options){ if(opt.value===val||opt.text===val){sel.value=opt.value;break;} }
}
function closeEditModal(){
  document.getElementById('modal-edit').classList.remove('open');
  const fab = document.querySelector('.fab-btn');
  if (fab) fab.style.display = '';
}

async function saveEdit(){
  const item=document.getElementById('e-item').value.trim();
  if(!item){ alert('í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const d=defects.find(x=>x.partNo===editingId); if(!d) return;
  d.carModel   = document.getElementById('e-carmodel').value||'-';
  d.partNo     = document.getElementById('e-partno').value||d.partNo;
  d.item=item; d.serial='-';
  d.type=document.getElementById('e-type').value; d.occurrence=document.getElementById('e-sev').value;
  d.qty=document.getElementById('e-qty').value||'-';
  d.owner=document.getElementById('e-owner').value||'ë¯¸ì§€ì •'; d.status=document.getElementById('e-status').value;
  d.date=document.getElementById('e-date').value; d.desc=document.getElementById('e-desc').value||'-';
  closeEditModal(); renderTable(); renderHomeDefects(); updateBadge(); renderDashboard();
  await sheetUpdate(d);
  showToast('success','ìˆ˜ì • ì™„ë£Œ',`${d.item}${GAS_URL?' Â· Sheets ì €ì¥ë¨':''}`);
}

async function deleteDefect(){
  if(!confirm(`[í’ˆë²ˆ: ${editingId}] ë¶ˆëŸ‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
  defects=defects.filter(x=>x.partNo!==editingId);
  closeEditModal(); renderTable(); renderHomeDefects(); updateBadge(); renderDashboard();
  await sheetDelete(editingId);
  showToast('info','ì‚­ì œ ì™„ë£Œ',`í’ˆë²ˆ ${editingId}${GAS_URL?' Â· Sheetsì—ì„œë„ ì‚­ì œë¨':''}`);
}

// â•â• ì—‘ì…€ ë‹¤ìš´ë¡œë“œ â•â•
function downloadExcel(){
  const list=getFiltered();
  const headers=['ì°¨ì¢…','í’ˆë²ˆ','í’ˆëª©ëª…','ì‹œë¦¬ì–¼','ë¶ˆëŸ‰ìœ í˜•','ë°œìƒì²˜','ë¶ˆëŸ‰ìˆ˜ëŸ‰','ê·€ì±…ì²˜','ë“±ë¡ì¼','ìƒíƒœ','ë¶ˆëŸ‰ë‚´ìš©'];
  const statusKo={open:'ë¯¸ì²˜ë¦¬',closed:'ì™„ë£Œ'};
  const rows=[headers,...list.map(d=>[d.carModel||'-',d.partNo||'-',d.item,d.serial||'-',d.type,d.occurrence||'-',d.qty||'-',d.owner,d.date,statusKo[d.status]||d.status,d.desc])];
  const csv='\uFEFF'+rows.map(r=>r.map(c=>{const s=String(c??'');return s.includes(',')||s.includes('\n')||s.includes('"')?`"${s.replace(/"/g,'""')}"`  :s;}).join(',')).join('\r\n');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})),download:`ë¶ˆëŸ‰í˜„í™©_${new Date().toISOString().slice(0,10)}.csv`});
  a.click(); URL.revokeObjectURL(a.href);
}

// â•â• CSV ì—…ë¡œë“œ â•â•
const COL_MAP={'ì°¨ì¢…':'carModel','í’ˆë²ˆ':'partNo','í’ˆëª©ëª…':'item','ì‹œë¦¬ì–¼':'serial','ë¶ˆëŸ‰ìœ í˜•':'type','ë°œìƒì²˜':'occurrence','ë¶ˆëŸ‰ìˆ˜ëŸ‰':'qty','ê·€ì±…ì²˜':'owner','ë“±ë¡ì¼':'date','ìƒíƒœ':'status','ë¶ˆëŸ‰ë‚´ìš©':'desc'};

function handleExcelUpload(input){
  const file=input.files[0]; if(!file) return; input.value='';
  if(!file.name.endsWith('.csv')) {
    showToast('info','í˜•ì‹ ì•ˆë‚´','CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.',6000); return;
  }
  // 1ì°¨: UTF-8 ì‹œë„ â†’ í•œê¸€ ê¹¨ì§€ë©´ EUC-KRë¡œ ì¬ì‹œë„
  const readerUTF = new FileReader();
  readerUTF.onload = e => {
    const text = e.target.result;
    // í•œê¸€ ê¹¨ì§ ê°ì§€: ìœ ë‹ˆì½”ë“œ ëŒ€ì²´ë¬¸ì(U+FFFD) ë˜ëŠ” ?ê°€ ê³¼ë„í•˜ê²Œ ë§ìœ¼ë©´ EUC-KRë¡œ ì¬ì‹œë„
    const brokenRatio = (text.match(/\uFFFD|\?{2,}/g)||[]).length / (text.length || 1);
    if (brokenRatio > 0.01) {
      // EUC-KRë¡œ ì¬ì‹œë„
      const readerEUC = new FileReader();
      readerEUC.onload = e2 => parseAndImport(e2.target.result, file.name);
      readerEUC.readAsText(file, 'EUC-KR');
    } else {
      parseAndImport(text, file.name);
    }
  };
  readerUTF.readAsText(file, 'UTF-8');
}

async function parseAndImport(csvText,filename){
  try{
    const text=csvText.replace(/^\uFEFF/,''), lines=text.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2){ showToast('error','íŒŒì¼ ì˜¤ë¥˜','ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const headers=parseCSVRow(lines[0]), keyMap={};
    headers.forEach((h,i)=>{ const key=COL_MAP[h.trim()]; if(key) keyMap[i]=key; });
    if(!Object.values(keyMap).includes('item')){ showToast('error','í—¤ë” ë¶ˆì¼ì¹˜','í’ˆëª©ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const newRows=[];
    for(let i=1;i<lines.length;i++){
      const cells=parseCSVRow(lines[i]); if(cells.every(c=>!c.trim())) continue;
      const row={status:'open',photos:[]};
      Object.entries(keyMap).forEach(([ci,field])=>{ row[field]=(cells[ci]||'').trim()||'-'; });
      if(!row.partNo||row.partNo==='-') row.partNo=`PN-IMP-${String(i).padStart(3,'0')}`;
      if(row.status) row.status=(row.status.includes('ë¯¸ì²˜ë¦¬')||row.status==='open')?'open':'closed';
      newRows.push(row);
    }
    if(!newRows.length){ showToast('error','ë°ì´í„° ì—†ìŒ','ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    let updated=0,added=0;
    newRows.forEach(row=>{ const idx=defects.findIndex(d=>d.partNo===row.partNo); if(idx>=0){defects[idx]={...defects[idx],...row};updated++;}else{defects.unshift(row);added++;} });
    renderTable(); renderHomeDefects(); updateBadge(); renderDashboard();
    showToast('success','ì—…ë¡œë“œ ì™„ë£Œ',`ì‹ ê·œ ${added}ê±´ ì¶”ê°€ Â· ${updated}ê±´ ì—…ë°ì´íŠ¸`);
    await sheetSync(false);
    if(GAS_URL) showToast('info','Sheets ë™ê¸°í™” ì™„ë£Œ','Google Sheetsì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(err){ showToast('error','íŒŒì‹± ì˜¤ë¥˜',err.message); }
}

function parseCSVRow(line){
  const result=[]; let cur='',inQ=false;
  for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(ch===','&&!inQ){result.push(cur);cur='';}else cur+=ch; }
  result.push(cur); return result;
}

// â•â• TOAST â•â•
function showToast(type,title,msg,duration=4000){
  const wrap=document.getElementById('toast-wrap'), icons={success:'âœ…',error:'âŒ',info:'â„¹ï¸'};
  const el=document.createElement('div'); el.className=`toast ${type}`;
  el.innerHTML=`<div class="toast-icon">${icons[type]||'ğŸ’¬'}</div><div class="toast-body"><div class="toast-title">${title}</div>${msg?`<div class="toast-msg">${msg}</div>`:''}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.classList.add('fade-out'); setTimeout(()=>el.remove(),300); },duration);
}

// â•â• ì‚¬ì§„ ì²¨ë¶€ â•â•
function handlePhotos(input){ const files=Array.from(input.files).slice(0,3-uploadedPhotos.length); files.forEach(f=>{ const r=new FileReader(); r.onload=e=>{uploadedPhotos.push(e.target.result);renderPhotoGrid();}; r.readAsDataURL(f); }); input.value=''; }
function removePhoto(i){ uploadedPhotos.splice(i,1); renderPhotoGrid(); }
function renderPhotoGrid(){
  const grid=document.getElementById('photo-grid');
  let html=uploadedPhotos.map((src,i)=>`<div class="photo-thumb-wrap"><img src="${src}"><div class="photo-remove" onclick="removePhoto(${i})">âœ•</div></div>`).join('');
  if(uploadedPhotos.length<3) html+=`<div class="photo-add-btn" onclick="document.getElementById('f-photos').click()"><span style="font-size:22px;">ğŸ“·</span><span>${uploadedPhotos.length===0?'ì‚¬ì§„ ì¶”ê°€':'ì¶”ê°€'}</span></div>`;
  grid.innerHTML=html;
}

// â•â• ë“œë˜ê·¸ ì•¤ ë“œë¡­ â•â•
document.addEventListener('dragover', e=>{ e.preventDefault(); document.getElementById('upload-overlay').classList.add('active'); });
document.addEventListener('dragleave', e=>{ if(!e.relatedTarget) document.getElementById('upload-overlay').classList.remove('active'); });
document.addEventListener('drop', e=>{
  e.preventDefault(); document.getElementById('upload-overlay').classList.remove('active');
  const file=e.dataTransfer.files[0]; if(!file) return;
  if(file.name.endsWith('.csv')){
    const readerUTF = new FileReader();
    readerUTF.onload = e => {
      const text = e.target.result;
      const brokenRatio = (text.match(/\uFFFD|\?{2,}/g)||[]).length / (text.length || 1);
      if (brokenRatio > 0.01) {
        const readerEUC = new FileReader();
        readerEUC.onload = e2 => parseAndImport(e2.target.result, file.name);
        readerEUC.readAsText(file, 'EUC-KR');
      } else {
        parseAndImport(text, file.name);
      }
    };
    readerUTF.readAsText(file, 'UTF-8');
  }
  else showToast('info','íŒŒì¼ í˜•ì‹ ì•ˆë‚´','.csv íŒŒì¼ì„ ë“œë˜ê·¸í•´ ì£¼ì„¸ìš”.');
});

// â•â• OVERLAY CLOSE â•â•
document.getElementById('modal-reg').addEventListener('click',    e=>{ if(e.target===e.currentTarget) closeModal(); });
document.getElementById('modal-detail').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeDetail(); });
document.getElementById('modal-edit').addEventListener('click',   e=>{ if(e.target===e.currentTarget) closeEditModal(); });

// â•â• ìë™ í´ë§ (Sheets â†’ ì›¹ì•± ìë™ ë™ê¸°í™”) â•â•
let countdownTimer = null;
let pollSeconds    = 60;
let countdown      = pollSeconds;
let isPolling      = false;

function togglePolling() {
  if (!GAS_URL) { showToast('error','Sheets ë¯¸ì—°ê²°','ë¨¼ì € Sheets ì—°ë™ ì„¤ì •ì„ í•´ì£¼ì„¸ìš”.'); return; }
  isPolling ? stopPolling() : startPolling();
}

function startPolling() {
  isPolling = true;
  countdown = pollSeconds;
  updatePollBtn();
  document.getElementById('sync-chip').classList.add('visible');
  silentSheetLoad(); // ì¦‰ì‹œ 1íšŒ ë¡œë“œ
  countdownTimer = setInterval(() => {
    countdown--;
    const el = document.getElementById('poll-countdown');
    if (el) el.textContent = countdown;
    if (countdown <= 0) { countdown = pollSeconds; silentSheetLoad(); }
  }, 1000);
}

function stopPolling() {
  isPolling = false;
  clearInterval(countdownTimer);
  countdownTimer = null;
  document.getElementById('sync-chip').classList.remove('visible');
  updatePollBtn();
  showToast('info','ìë™ ë™ê¸°í™” ì¤‘ì§€','êº¼ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¼œë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.');
}

function updatePollBtn() {
  const btn = document.getElementById('poll-btn'); if (!btn) return;
  if (isPolling) {
    btn.innerHTML = '<span class="poll-dot"></span> ë™ê¸°í™” ì¤‘';
    btn.style.color = 'var(--success)';
    btn.style.borderColor = 'rgba(5,122,85,0.4)';
  } else {
    btn.innerHTML = 'â± ìë™ë™ê¸°í™”';
    btn.style.color = 'var(--sidebar-text)';
    btn.style.borderColor = 'rgba(255,255,255,0.1)';
  }
}

// ì¡°ìš©íˆ ë¡œë“œ â€” ê±´ìˆ˜Â·ë‚´ìš© ë¬´ê´€í•˜ê²Œ í•­ìƒ ì „ì²´ êµì²´
async function silentSheetLoad() {
  if (!GAS_URL) return;
  try {
    const res  = await fetch(GAS_URL + '?t=' + Date.now()); // ìºì‹œ ë°©ì§€
    const json = await res.json();
    if (!json.ok) return;
    const newData = json.data || [];
    // ê±´ìˆ˜ OR ë‚´ìš© ì¤‘ í•˜ë‚˜ë¼ë„ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
    const prevSig = defects.map(d => d.partNo + d.status + d.item).join('|');
    const newSig  = newData.map(d => d.partNo + d.status + d.item).join('|');
    if (newData.length !== defects.length || prevSig !== newSig) {
      defects = newData.map(d => ({ ...d, photos:[] }));
      renderHomeDefects(); renderTable(); updateBadge(); renderDashboard();
      showToast('info','Sheets ë³€ê²½ ê°ì§€', `${defects.length}ê±´ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 2500);
    }
  } catch(e) { /* í´ë§ ì˜¤ë¥˜ ë¬´ì‹œ */ }
}

// â•â• INIT â•â•
renderHomeDefects();
renderDashboard();
updateBadge();
updateSheetBtn();
updatePollBtn();
if (GAS_URL) sheetLoad();
</script>
</body>
</html>
